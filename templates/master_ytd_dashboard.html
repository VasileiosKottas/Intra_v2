<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team YTD Performance Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/master.css') }}">
    <style>
        .ytd-dashboard {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .dashboard-header h1 {
            margin: 0 0 20px 0;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            opacity: 0.9;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }

        .control-group select option {
            background: #333;
            color: white;
        }

        .btn-primary, .btn-secondary {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .dashboard-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .section-subtitle {
            font-size: 1.3rem;
            color: #333;
            margin: 30px 0 15px 0;
            font-weight: 600;
        }
        
        .ytd-section {
            margin-bottom: 40px;
        }

        .team-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f5f7ff 0%, #e8f2ff 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e1e8f0;
        }

        .summary-card h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .month-section {
            margin-bottom: 40px;
        }

        .month-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            margin: 0 0 20px 0;
            border-radius: 8px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9rem;
        }

        .performance-table th {
            background: #f8f9fa;
            color: #333;
            padding: 15px 8px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            font-size: 0.85rem;
        }

        .performance-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }

        .performance-table tr:hover {
            background: #f8f9fa;
        }

        .totals-row {
            background: #e8f2ff !important;
            font-weight: 600;
        }

        .totals-row:hover {
            background: #d4edda !important;
        }

        .currency {
            color: #28a745;
            font-weight: 600;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.1rem;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        /* Company theme switching */
        body.cnc-theme .dashboard-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        body.cnc-theme .tab-button.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        body.cnc-theme .section-title {
            border-bottom-color: #ff6b6b;
        }

        body.cnc-theme .month-title {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .dashboard-tabs {
                flex-direction: column;
            }
            
            .team-summary {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="ytd-dashboard">
        <div class="dashboard-header">
            <h1>Team YTD Performance Dashboard</h1>
            <div class="controls-grid">
                <div class="control-group">
                    <label for="companySelect">Company</label>
                    <select id="companySelect" onchange="loadAvailableTeams()">
                        <option value="windsor">Windsor</option>
                        <option value="cnc">C&C</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="teamSelect">Select Team</label>
                    <select id="teamSelect">
                        <option value="">Select a team...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="startDateSelect">Start Date</label>
                    <input type="date" id="startDateSelect">
                </div>
                <div class="control-group">
                    <label for="endDateSelect">End Date</label>
                    <input type="date" id="endDateSelect">
                </div>
                <button class="btn-primary" onclick="loadDashboard()">Load Dashboard</button>
                <button class="btn-primary" onclick="downloadExcel()" id="downloadBtn" style="display:none;">Download Excel</button>
                <button class="btn-secondary" onclick="testCalendly()">Test Calendly</button>
            </div>
        </div>

        <div class="dashboard-tabs">
            <button class="tab-button active" onclick="switchTab('activity')">Activity & Submitted</button>
            <button class="tab-button" onclick="switchTab('ytd-totals')">YTD Totals</button>
        </div>

        <!-- Activity & Submitted Tab -->
        <div id="activity-tab" class="tab-content active">
            <div class="section-title">Activity & Submitted Report</div>
            <div id="activity-content">
                <div class="loading">Select a team and date range to load activity data</div>
            </div>
        </div>

        <!-- YTD Totals Tab -->
        <div id="ytd-totals-tab" class="tab-content">
            <div class="section-title">YTD Totals Dashboard</div>
            <div id="ytd-content">
                <div class="loading">Select a team and date range to load YTD totals</div>
            </div>
        </div>


    </div>

    <script>
        let currentTeam = null;
        let currentEndDate = null;
        let currentStartDate = null;
        let currentCompany = 'windsor';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date();
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            
            document.getElementById('endDateSelect').value = today.toISOString().split('T')[0];
            document.getElementById('startDateSelect').value = startOfYear.toISOString().split('T')[0];
            
            loadAvailableTeams();
        });

        async function loadAvailableTeams() {
            try {
                const company = document.getElementById('companySelect').value;
                currentCompany = company;
                
                // Update theme based on company
                updateCompanyTheme();
                
                // Switch company context
                await fetch('/api/set-company', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ company: company })
                });
                
                const response = await fetch('/api/teams/performance-available');
                const data = await response.json();

                const teamSelect = document.getElementById('teamSelect');
                teamSelect.innerHTML = '<option value="">Select a team...</option>';

                if (data.success && data.teams) {
                    data.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = `${team.name} (${team.member_count} members)`;
                        teamSelect.appendChild(option);
                    });
                }
                
                // Clear the current dashboard when company changes
                document.getElementById('activity-content').innerHTML = '<div class="loading">Select a team and date range to load activity data</div>';
                document.getElementById('downloadBtn').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading teams:', error);
                showError('activity-content', 'Error loading teams: ' + error.message);
            }
        }

        function updateCompanyTheme() {
            if (currentCompany === 'cnc') {
                document.body.classList.add('cnc-theme');
            } else {
                document.body.classList.remove('cnc-theme');
            }
        }

        async function loadDashboard() {
            const teamId = document.getElementById('teamSelect').value;
            const startDate = document.getElementById('startDateSelect').value;
            const endDate = document.getElementById('endDateSelect').value;

            if (!teamId) {
                showError('activity-content', 'Please select a team');
                return;
            }

            if (!startDate || !endDate) {
                showError('activity-content', 'Please select both start and end dates');
                return;
            }

            currentTeam = teamId;
            currentStartDate = startDate;
            currentEndDate = endDate;

            // Show download button
            document.getElementById('downloadBtn').style.display = 'inline-block';

            // Load data for active tab
            const activeTab = document.querySelector('.tab-button.active').textContent.toLowerCase();
            
            if (activeTab.includes('activity')) {
                await loadActivityData();
            } else if (activeTab.includes('ytd')) {
                await loadYTDTotals();

            }
        }

        async function loadActivityData() {
            try {
                showLoading('activity-content', 'Loading activity data with Calendly integration...');
                
                const response = await fetch(`/api/teams/ytd-performance/${currentTeam}?end_date=${currentEndDate}&start_date=${currentStartDate}`);
                const data = await response.json();

                console.log('Activity data received:', data);

                if (data.success) {
                    displayActivityData(data);
                } else {
                    showError('activity-content', data.error || 'Failed to load activity data');
                }
            } catch (error) {
                showError('activity-content', 'Error loading activity data: ' + error.message);
            }
        }

        function displayActivityData(data) {
            const container = document.getElementById('activity-content');
            
            // Check if we have the expected data structure
            if (!data.monthly_data || data.monthly_data.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        No monthly data found for the selected period.
                        <br>Please check your date range and team selection.
                    </div>
                `;
                return;
            }

            // Display team info
            let html = `
                <div class="team-summary">
                    <div class="summary-card">
                        <h4>Team</h4>
                        <div class="value">${data.team_name || 'Unknown Team'}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Company</h4>
                        <div class="value">${currentCompany.toUpperCase()}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Period</h4>
                        <div class="value">${data.date_range ? data.date_range.period : 'Unknown Period'}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Total Activity</h4>
                        <div class="value">${data.ytd_totals ? data.ytd_totals.total_activity : 0}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Total Submitted</h4>
                        <div class="value">£${formatNumber(data.ytd_totals ? data.ytd_totals.submitted_total : 0)}</div>
                    </div>
                </div>
            `;

            // Process monthly data
            data.monthly_data.forEach(month => {
                html += `
                    <div class="month-section">
                        <h3 class="month-title">${month.month}</h3>
                        <div class="table-container">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Advisor</th>
                                        <th>Apps<br>Booked</th>
                                        <th>Apps<br>Completed</th>
                                        <th>Outbound<br>Calls</th>
                                        <th>Total<br>Activity</th>`;
                
                // Company-specific headers
                if (currentCompany === 'cnc') {
                    html += `
                                        <th>C&C<br>Apps</th>`;
                } else {
                    html += `
                                        <th>Mortgage<br>Apps</th>
                                        <th>Insurance<br>Apps</th>
                                        <th>Insurance<br>Referrals</th>
                                        <th>Other<br>Referrals</th>`;
                }
                
                html += `
                                        <th>Submitted<br>Total</th>
                                        <th>Conversion<br>%</th>
                                        <th>Target</th>
                                        <th>Vs Target</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                // Check if month has members
                if (!month.members || month.members.length === 0) {
                    const colCount = currentCompany === 'cnc' ? 10 : 13;
                    html += `
                        <tr>
                            <td colspan="${colCount}" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                No member data for ${month.month}
                            </td>
                        </tr>
                    `;
                } else {
                    month.members.forEach(member => {
                        html += `
                            <tr>
                                <td style="text-align: left; font-weight: 600;">${member.advisor || 'Unknown'}</td>
                                <td>${member.appointments_booked || 0}</td>
                                <td>${member.appointments_completed || 0}</td>
                                <td>${member.outbound_calls || 0}</td>
                                <td><strong>${member.total_activity || 0}</strong></td>`;
                        
                        // Company-specific data columns
                        if (currentCompany === 'cnc') {
                            html += `
                                <td>${member.cnc_apps || 0}</td>`;
                        } else {
                            html += `
                                <td>${member.mortgage_apps || 0}</td>
                                <td>${member.insurance_apps || 0}</td>
                                <td>${member.insurance_referrals || 0}</td>
                                <td>${member.other_referrals || 0}</td>`;
                        }
                        
                        html += `
                                <td class="currency">£${formatNumber(member.submitted_total || 0)}</td>
                                <td>${member.conversion_rate || 0}%</td>
                                <td>£${formatNumber(member.monthly_target || 0)}</td>
                                <td class="${(member.vs_target || 0) >= 0 ? 'currency' : 'negative'}">£${formatNumber(member.vs_target || 0)}</td>
                            </tr>
                        `;
                    });

                    // Add totals row if totals exist
                    if (month.totals) {
                        const totals = month.totals;
                        html += `
                                <tr class="totals-row">
                                    <td style="text-align: left;"><strong>Totals:</strong></td>
                                    <td><strong>${totals.appointments_booked || 0}</strong></td>
                                    <td><strong>${totals.appointments_completed || 0}</strong></td>
                                    <td><strong>${totals.outbound_calls || 0}</strong></td>
                                    <td><strong>${totals.total_activity || 0}</strong></td>`;
                        
                        // Company-specific totals
                        if (currentCompany === 'cnc') {
                            html += `
                                    <td><strong>${totals.cnc_apps || 0}</strong></td>`;
                        } else {
                            html += `
                                    <td><strong>${totals.mortgage_apps || 0}</strong></td>
                                    <td><strong>${totals.insurance_apps || 0}</strong></td>
                                    <td><strong>${totals.insurance_referrals || 0}</strong></td>
                                    <td><strong>${totals.other_referrals || 0}</strong></td>`;
                        }
                        
                        html += `
                                    <td><strong>£${formatNumber(totals.submitted_total || 0)}</strong></td>
                                    <td><strong>-</strong></td>
                                    <td><strong>£${formatNumber(totals.monthly_target || 0)}</strong></td>
                                    <td><strong>-</strong></td>
                                </tr>
                        `;
                    }
                }

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function loadYTDTotals() {
            try {
                showLoading('ytd-content', 'Loading YTD totals...');
                
                const response = await fetch(`/api/teams/ytd-totals/${currentTeam}?end_date=${currentEndDate}&start_date=${currentStartDate}`);
                const data = await response.json();

                if (data.success) {
                    displayYTDTotals(data);
                } else {
                    showError('ytd-content', data.error || 'Failed to load YTD totals');
                }
            } catch (error) {
                showError('ytd-content', 'Error loading YTD totals: ' + error.message);
            }
        }

        function displayYTDTotals(data) {
            const container = document.getElementById('ytd-content');
            
            // Check if we have YTD data
            if (!data.ytd_data) {
                container.innerHTML = `
                    <div class="error">
                        No YTD data found for the selected period.
                        <br>Please check your date range and team selection.
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="team-summary">
                    <div class="summary-card">
                        <h4>Team</h4>
                        <div class="value">${data.team_name || 'Unknown Team'}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Company</h4>
                        <div class="value">${currentCompany.toUpperCase()}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Period</h4>
                        <div class="value">${data.date_range ? data.date_range.start + ' to ' + data.date_range.end : 'N/A'}</div>
                    </div>
                </div>
            `;
            
            // Total Submitted Table with Q3 and Q4
            if (data.ytd_data.total_submitted && data.ytd_data.total_submitted.length > 0) {
                html += `
                    <div class="ytd-section">
                        <h3 class="section-subtitle">Total Submitted</h3>
                        <div class="table-container">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Advisor</th>
                                        <th>Quarter 1</th>
                                        <th>Quarter 2</th>
                                        <th>Quarter 3</th>
                                        <th>Quarter 4</th>
                                        <th>YTD Total</th>
                                        <th>Yearly Target</th>
                                        <th>Vs Target</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                let totalSubmittedYTD = 0;
                let totalYearlyTarget = 0;
                let totalQ1 = 0;
                let totalQ2 = 0;
                let totalQ3 = 0;
                let totalQ4 = 0;
                
                data.ytd_data.total_submitted.forEach(advisor => {
                    totalSubmittedYTD += advisor.ytd_total || 0;
                    totalYearlyTarget += advisor.yearly_target || 0;
                    totalQ1 += advisor.q1 || 0;
                    totalQ2 += advisor.q2 || 0;
                    totalQ3 += advisor.q3 || 0;
                    totalQ4 += advisor.q4 || 0;
                    
                    const vsTarget = advisor.vs_target || 0;
                    const vsTargetClass = vsTarget >= 0 ? 'currency' : 'negative';
                    
                    html += `
                        <tr>
                            <td style="text-align: left; font-weight: 600;">${advisor.advisor || 'Unknown'}</td>
                            <td class="currency">£${formatNumber(advisor.q1 || 0)}</td>
                            <td class="currency">£${formatNumber(advisor.q2 || 0)}</td>
                            <td class="currency">£${formatNumber(advisor.q3 || 0)}</td>
                            <td class="currency">£${formatNumber(advisor.q4 || 0)}</td>
                            <td class="currency"><strong>£${formatNumber(advisor.ytd_total || 0)}</strong></td>
                            <td>£${formatNumber(advisor.yearly_target || 0)}</td>
                            <td class="${vsTargetClass}">£${formatNumber(vsTarget)}</td>
                        </tr>
                    `;
                });
                
                const totalVsTarget = totalSubmittedYTD - totalYearlyTarget;
                const totalVsTargetClass = totalVsTarget >= 0 ? 'currency' : 'negative';
                
                html += `
                        <tr class="totals-row">
                            <td style="text-align: left;"><strong>Totals:</strong></td>
                            <td class="currency"><strong>£${formatNumber(totalQ1)}</strong></td>
                            <td class="currency"><strong>£${formatNumber(totalQ2)}</strong></td>
                            <td class="currency"><strong>£${formatNumber(totalQ3)}</strong></td>
                            <td class="currency"><strong>£${formatNumber(totalQ4)}</strong></td>
                            <td class="currency"><strong>£${formatNumber(totalSubmittedYTD)}</strong></td>
                            <td><strong>£${formatNumber(totalYearlyTarget)}</strong></td>
                            <td class="${totalVsTargetClass}"><strong>£${formatNumber(totalVsTarget)}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
                `;
            }
            
            // Appointments Completed Table with Q3 and Q4
            if (data.ytd_data.appointments_completed && data.ytd_data.appointments_completed.length > 0) {
                html += `
                    <div class="ytd-section">
                        <h3 class="section-subtitle">Appointments Completed</h3>
                        <div class="table-container">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Advisor</th>
                                        <th>Quarter 1</th>
                                        <th>Quarter 2</th>
                                        <th>Quarter 3</th>
                                        <th>Quarter 4</th>
                                        <th>YTD Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                let totalApptsYTD = 0;
                let totalApptsQ1 = 0;
                let totalApptsQ2 = 0;
                let totalApptsQ3 = 0;
                let totalApptsQ4 = 0;
                
                data.ytd_data.appointments_completed.forEach(advisor => {
                    totalApptsYTD += advisor.ytd_total || 0;
                    totalApptsQ1 += advisor.q1 || 0;
                    totalApptsQ2 += advisor.q2 || 0;
                    totalApptsQ3 += advisor.q3 || 0;
                    totalApptsQ4 += advisor.q4 || 0;
                    
                    html += `
                        <tr>
                            <td style="text-align: left; font-weight: 600;">${advisor.advisor || 'Unknown'}</td>
                            <td>${advisor.q1 || 0}</td>
                            <td>${advisor.q2 || 0}</td>
                            <td>${advisor.q3 || 0}</td>
                            <td>${advisor.q4 || 0}</td>
                            <td style="font-weight: 600;">${advisor.ytd_total || 0}</td>
                        </tr>
                    `;
                });
                
                html += `
                        <tr class="totals-row">
                            <td style="text-align: left;"><strong>Totals:</strong></td>
                            <td><strong>${totalApptsQ1}</strong></td>
                            <td><strong>${totalApptsQ2}</strong></td>
                            <td><strong>${totalApptsQ3}</strong></td>
                            <td><strong>${totalApptsQ4}</strong></td>
                            <td><strong>${totalApptsYTD}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
                `;
            }
            
            // ADD NEW: Appointments Booked Table with Q3 and Q4
            if (data.ytd_data.appointments_booked && data.ytd_data.appointments_booked.length > 0) {
                html += `
                    <div class="ytd-section">
                        <h3 class="section-subtitle">Appointments Booked</h3>
                        <div class="table-container">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Advisor</th>
                                        <th>Quarter 1</th>
                                        <th>Quarter 2</th>
                                        <th>Quarter 3</th>
                                        <th>Quarter 4</th>
                                        <th>YTD Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                let totalBookedYTD = 0;
                let totalBookedQ1 = 0;
                let totalBookedQ2 = 0;
                let totalBookedQ3 = 0;
                let totalBookedQ4 = 0;
                
                data.ytd_data.appointments_booked.forEach(advisor => {
                    totalBookedYTD += advisor.ytd_total || 0;
                    totalBookedQ1 += advisor.q1 || 0;
                    totalBookedQ2 += advisor.q2 || 0;
                    totalBookedQ3 += advisor.q3 || 0;
                    totalBookedQ4 += advisor.q4 || 0;
                    
                    html += `
                        <tr>
                            <td style="text-align: left; font-weight: 600;">${advisor.advisor || 'Unknown'}</td>
                            <td>${advisor.q1 || 0}</td>
                            <td>${advisor.q2 || 0}</td>
                            <td>${advisor.q3 || 0}</td>
                            <td>${advisor.q4 || 0}</td>
                            <td style="font-weight: 600;">${advisor.ytd_total || 0}</td>
                        </tr>
                    `;
                });
                
                html += `
                        <tr class="totals-row">
                            <td style="text-align: left;"><strong>Totals:</strong></td>
                            <td><strong>${totalBookedQ1}</strong></td>
                            <td><strong>${totalBookedQ2}</strong></td>
                            <td><strong>${totalBookedQ3}</strong></td>
                            <td><strong>${totalBookedQ4}</strong></td>
                            <td><strong>${totalBookedYTD}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
                `;
            }
            
            // ADD NEW: Outbound Calls Table with Q3 and Q4
            if (data.ytd_data.outbound_calls && data.ytd_data.outbound_calls.length > 0) {
                html += `
                    <div class="ytd-section">
                        <h3 class="section-subtitle">Outbound Calls</h3>
                        <div class="table-container">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Advisor</th>
                                        <th>Quarter 1</th>
                                        <th>Quarter 2</th>
                                        <th>Quarter 3</th>
                                        <th>Quarter 4</th>
                                        <th>YTD Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                let totalCallsYTD = 0;
                let totalCallsQ1 = 0;
                let totalCallsQ2 = 0;
                let totalCallsQ3 = 0;
                let totalCallsQ4 = 0;
                
                data.ytd_data.outbound_calls.forEach(advisor => {
                    totalCallsYTD += advisor.ytd_total || 0;
                    totalCallsQ1 += advisor.q1 || 0;
                    totalCallsQ2 += advisor.q2 || 0;
                    totalCallsQ3 += advisor.q3 || 0;
                    totalCallsQ4 += advisor.q4 || 0;
                    
                    html += `
                        <tr>
                            <td style="text-align: left; font-weight: 600;">${advisor.advisor || 'Unknown'}</td>
                            <td>${advisor.q1 || 0}</td>
                            <td>${advisor.q2 || 0}</td>
                            <td>${advisor.q3 || 0}</td>
                            <td>${advisor.q4 || 0}</td>
                            <td style="font-weight: 600;">${advisor.ytd_total || 0}</td>
                        </tr>
                    `;
                });
                
                html += `
                        <tr class="totals-row">
                            <td style="text-align: left;"><strong>Totals:</strong></td>
                            <td><strong>${totalCallsQ1}</strong></td>
                            <td><strong>${totalCallsQ2}</strong></td>
                            <td><strong>${totalCallsQ3}</strong></td>
                            <td><strong>${totalCallsQ4}</strong></td>
                            <td><strong>${totalCallsYTD}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
                `;
            }
            
            // Total Apps Table with Q3 and Q4
            if (data.ytd_data.total_apps && data.ytd_data.total_apps.length > 0) {
                html += `
                    <div class="ytd-section">
                        <h3 class="section-subtitle">Total Apps</h3>
                        <div class="table-container">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Advisor</th>
                                        <th>Quarter 1</th>
                                        <th>Quarter 2</th>
                                        <th>Quarter 3</th>
                                        <th>Quarter 4</th>
                                        <th>YTD Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                let totalAppsYTD = 0;
                let totalAppsQ1 = 0;
                let totalAppsQ2 = 0;
                let totalAppsQ3 = 0;
                let totalAppsQ4 = 0;
                
                data.ytd_data.total_apps.forEach(advisor => {
                    totalAppsYTD += advisor.ytd_total || 0;
                    totalAppsQ1 += advisor.q1 || 0;
                    totalAppsQ2 += advisor.q2 || 0;
                    totalAppsQ3 += advisor.q3 || 0;
                    totalAppsQ4 += advisor.q4 || 0;
                    
                    html += `
                        <tr>
                            <td style="text-align: left; font-weight: 600;">${advisor.advisor || 'Unknown'}</td>
                            <td>${advisor.q1 || 0}</td>
                            <td>${advisor.q2 || 0}</td>
                            <td>${advisor.q3 || 0}</td>
                            <td>${advisor.q4 || 0}</td>
                            <td style="font-weight: 600;">${advisor.ytd_total || 0}</td>
                        </tr>
                    `;
                });
                
                html += `
                        <tr class="totals-row">
                            <td style="text-align: left;"><strong>Totals:</strong></td>
                            <td><strong>${totalAppsQ1}</strong></td>
                            <td><strong>${totalAppsQ2}</strong></td>
                            <td><strong>${totalAppsQ3}</strong></td>
                            <td><strong>${totalAppsQ4}</strong></td>
                            <td><strong>${totalAppsYTD}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
                `;
            }
            
            container.innerHTML = html;
        }



        async function downloadExcel() {
            if (!currentTeam) {
                alert('Please select a team first');
                return;
            }
            
            if (!currentEndDate || !currentStartDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const downloadBtn = document.getElementById('downloadBtn');
            const originalText = downloadBtn.textContent;
            
            try {
                // Show loading state
                downloadBtn.textContent = 'Generating Excel...';
                downloadBtn.disabled = true;
                
                // Build the download URL with parameters
                const params = new URLSearchParams({
                    end_date: currentEndDate,
                    start_date: currentStartDate
                });
                
                const downloadUrl = `/api/teams/ytd-excel/${currentTeam}?${params.toString()}`;
                
                console.log('Downloading Excel from:', downloadUrl);
                
                // Create a temporary link and trigger download
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                showSuccessMessage('Excel report download started successfully');
                
            } catch (error) {
                console.error('Excel download error:', error);
                alert('Failed to download Excel: ' + error.message);
            } finally {
                // Reset button
                setTimeout(() => {
                    downloadBtn.textContent = originalText;
                    downloadBtn.disabled = false;
                }, 2000);
            }
        }
        function showSuccessMessage(message) {
            // Create a temporary success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 500;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
        async function testCalendly() {
            const testBtn = event.target;
            const originalText = testBtn.textContent;
            testBtn.textContent = 'Testing...';
            testBtn.disabled = true;

            try {
                // Test Calendly connection
                const debugResponse = await fetch('/api/test/calendly-debug');
                const debugData = await debugResponse.json();

                // Test available emails
                const emailsResponse = await fetch('/api/test/calendly-emails');
                const emailsData = await emailsResponse.json();

                // Show results
                let message = 'Calendly Test Results:\n\n';
                message += `Connection: ${debugData.calendly_status || debugData.error || 'Unknown'}\n`;
                message += `Token: ${debugData.has_token ? 'Present' : 'Missing'}\n`;
                message += `Users Found: ${emailsData.total_users || 0}\n`;

                alert(message);
            } catch (error) {
                alert('Test failed: ' + error.message);
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data for the selected tab if we have a team selected
            if (currentTeam && currentEndDate) {
                if (tabName === 'activity') {
                    loadActivityData();
                } else if (tabName === 'ytd-totals') {
                    loadYTDTotals();
                }
            }
        }

        function showLoading(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="loading">${message}</div>`;
        }

        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="error">${message}</div>`;
        }

        function formatNumber(num) {
            if (num == null) return '0';
            return parseFloat(num).toLocaleString('en-GB', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    </script>
</body>
</html>