<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ advisor.full_name }} - Dashboard View</title>
    
    <!-- CSS Files - Same as main dashboard -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/metrics.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <link rel="stylesheet" href="/static/css/dashboard-enhanced.css">
    
    <!-- Add custom styles for company toggle and viewing indicator -->
    <style>
        :root {
            /* Windsor Colors (Light Theme) */
            --primary-color: #122747;
            --secondary-color: #667eea;
            --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --header-gradient: linear-gradient(135deg, #122747 0%, #122747 100%);
            --text-color: #122747;
            --card-background: white;
            --border-color: #e1e8ed;
        }

        /* CnC Colors (Dark Theme) */
        body.cnc-theme {
            --primary-color: #000000;
            --secondary-color: #f19420;
            --background-gradient: linear-gradient(135deg, #ffffff 0%, #f19420 100%);
            --header-gradient: linear-gradient(135deg, #000000 0%, #000000 100%);
            --text-color: #000000;
            --card-background: #ffffff;
            --border-color: #ffffff;
        }

        body {
            background: var(--background-gradient);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .header {
            background: var(--header-gradient);
            transition: all 0.3s ease;
        }

        .viewing-indicator {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .period-selector {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 0.5rem;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .period-selector:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .period-selector option {
            background: var(--primary-color);
            color: white;
        }
        
        .company-indicator {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 0.5rem;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Dark theme for cards and sections */
        body.cnc-theme .metric-card,
        body.cnc-theme .chart-section,
        body.cnc-theme .team-target,
        body.cnc-theme .user-goal-section,
        body.cnc-theme .leaderboard-section,
        body.cnc-theme .cases-section,
        body.cnc-theme .performance-chart-section,
        body.cnc-theme .combined-goals-section,
        body.cnc-theme .cases-section-fullwidth {
            background: var(--card-background);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        body.cnc-theme .dashboard-title {
            background: linear-gradient(135deg, var(--text-color) 0%, var(--text-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.cnc-theme .metric-value,
        body.cnc-theme .chart-title,
        body.cnc-theme .leaderboard-title,
        body.cnc-theme .cases-title {
            color: var(--text-color);
        }

        body.cnc-theme .period-btn {
            background: var(--card-background);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        body.cnc-theme .period-btn.active {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-color) 100%);
        }

        body.cnc-theme .refresh-btn {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-color) 100%);
        }

        body.cnc-theme .filter-select {
            background: var(--card-background);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        body.cnc-theme .leaderboard-table,
        body.cnc-theme .cases-table {
            background: var(--card-background);
        }

        body.cnc-theme .leaderboard-table th,
        body.cnc-theme .cases-table th {
            background: linear-gradient(135deg, #ffffff 0%, #e9e3dd 100%);
            color: rgb(0, 0, 0);
        }

        body.cnc-theme .leaderboard-table td,
        body.cnc-theme .cases-table td {
            color: var(--text-color);
            border-bottom-color: var(--border-color);
        }

        body.cnc-theme .metric-card::before {
            background: linear-gradient(90deg, var(--secondary-color), var(--secondary-color));
        }

        body.cnc-theme .target-row,
        body.cnc-theme .goal-row {
            background: var(--border-color);
            color: var(--text-color);
        }

        body.cnc-theme .cases-table-container {
            border-color: var(--border-color);
        }

        /* Responsive adjustments for header */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .header h1 {
                flex: 1;
                min-width: 200px;
            }
            
            .header-actions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .period-selector {
                font-size: 0.85rem;
                padding: 0.4rem;
            }
            
            .company-indicator {
                font-size: 0.7rem;
                padding: 0.2rem 0.5rem;
            }
            
            .back-btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            .viewing-indicator {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }

        /* Logo switching styles */
        .logo {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="{{ 'cnc-theme' if session.get('company_mode', 'windsor') == 'cnc' else '' }}">
    <div class="header">
        <h1>
            <img src="{{ url_for('static', filename='images/' + ('CnC.png' if session.get('company_mode', 'windsor') == 'cnc' else company_config.logo)) }}"
                alt="Company logo" class="logo {{ 'cnc-logo' if session.get('company_mode', 'windsor') == 'cnc' else '' }}" id="company-logo">
            <span id="suite-name">{{ 'CSuite' if session.get('company_mode', 'windsor') == 'cnc' else 'WinSuite' }}</span>
        </h1>
        <div class="user-info">
            <div class="viewing-indicator">
                üëÅÔ∏è Viewing: {{ advisor.full_name }}
            </div>

            <span class="company-indicator">{{ company_config.name }}</span>
            <a href="/master" class="back-btn">
                ‚Üê Back to Master
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="dashboard-header">
            <h2 class="dashboard-title">{{ advisor.full_name }}'s Performance Dashboard</h2>
            <p class="dashboard-subtitle">
                {% if advisor.team %}
                    Team: {{ advisor.team.name }}
                    {% if advisor.team.is_hidden %} (Hidden Team){% endif %}
                {% else %}
                    Individual Advisor - No Team Assigned
                {% endif %}
            </p>
            
            <div class="period-controls">
                <span>Period:</span>
                <button class="period-btn active" data-period="month">Month to Date</button>
                <button class="period-btn" data-period="quarter">Last Quarter</button>
                <button class="period-btn" data-period="year">Year to Date</button>
                <button class="period-btn" data-period="custom">Custom Range</button>
            </div>

            <!-- Custom Date Picker Modal -->
            <div id="customDateModal" class="date-modal">
                <div class="date-modal-content">
                    <div class="date-modal-header">
                        <h3>Select Custom Date Range</h3>
                        <button class="close-date-modal" onclick="closeDateModal()">&times;</button>
                    </div>
                    <div class="date-inputs">
                        <div class="date-input-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate" class="date-input">
                        </div>
                        <div class="date-input-group">
                            <label for="endDate">End Date:</label>
                            <input type="date" id="endDate" class="date-input">
                        </div>
                    </div>
                    <div class="date-modal-buttons">
                        <button class="btn-cancel" onclick="closeDateModal()">Cancel</button>
                        <button class="btn-apply" onclick="applyCustomDates()">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card proc">
                <div class="metric-header">
                    <span class="metric-icon">üìÑ</span>
                    <span>Total Submitted</span>
                </div>
                <div class="metric-value" id="total-submitted">¬£0.00</div>
                <div class="metric-detail">Proc: ¬£<span id="your-proc">0.00</span></div>
                <div class="metric-detail">Fee: ¬£<span id="your-fee">0.00</span></div>
                <div class="metric-value" style="color: var(--secondary-color); margin-top: 1rem; font-size: 1.5rem;">
                    ¬£<span id="combined-total">0.00</span>
                </div>
                <div class="metric-detail">Combined Total</div>
            </div>

            <div class="metric-card paid">
                <div class="metric-header">
                    <span class="metric-icon">üí∑</span>
                    <span>Total Paid</span>
                </div>
                <div class="metric-value" id="total-paid">¬£0.00</div>
                <div class="metric-detail">From Payment Form</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="payment-progress" style="width: 0%"></div>
                </div>
                <div class="metric-detail"><span id="payment-percentage">0</span>% of submitted amount</div>
            </div>

            <div class="metric-card applications">
                <div class="metric-header">
                    <span class="metric-icon">üìã</span>
                    <span>Applications</span>
                </div>
                <div class="metric-value" id="total-applications">0</div>
                <div class="metric-detail" id="applications-breakdown">
                    Loading applications...
                </div>
                <div class="metric-detail">Average per Application: ¬£<span id="avg-per-application">0.00</span></div>
            </div>

            <div class="metric-card referrals">
                <div class="metric-header">
                    <span class="metric-icon">üîÑ</span>
                    <span>Referrals</span>
                </div>
                <div class="metric-value" id="referrals-made">0</div>
                <div class="metric-detail">Referrals made</div>
                <div style="margin-top: 1rem;">
                    <div style="font-weight: 600; color: var(--secondary-color);">Made: <span id="referrals-made-count">0</span></div>
                    <div style="color: #7f8c8d;">Received: <span id="referrals-received-count">0</span></div>
                </div>
            </div>
        </div>

        <!-- Full-width Performance Chart Section -->
        <div class="performance-chart-section">
            <div class="chart-header">
                <div class="chart-title">üìà Performance Timeline</div>
                <div class="chart-controls">
                    <button class="chart-btn active" data-type="submitted">Total Submitted</button>
                    <button class="chart-btn" data-type="paid">Total Paid</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performance-chart"></canvas>
            </div>
            <div class="chart-stats">
                <div class="chart-stat">
                    <span class="stat-label">Current Total:</span>
                    <span class="stat-value">¬£<span id="chart-total">0.00</span></span>
                </div>
                <div class="chart-stat">
                    <span class="stat-label">Best Period:</span>
                    <span class="stat-value">¬£<span id="chart-best">0.00</span></span>
                </div>
                <div class="chart-stat">
                    <span class="stat-label">Yearly Goal:</span>
                    <span class="stat-value">¬£<span id="yearly-goal">0.00</span></span>
                </div>
                <div class="chart-stat">
                    <span class="stat-label">Goal Progress:</span>
                    <span class="stat-value"><span id="yearly-progress">0</span>%</span>
                </div>
            </div>
        </div>

        <!-- Two Column Layout for Team Data -->
        <div class="dashboard-two-column">
            <!-- Left Column - Team Leaderboard -->
            <div class="left-column">
                <div class="leaderboard-section">
                    <div class="leaderboard-header">
                        <div class="leaderboard-title">üèÜ Team Leaderboard</div>
                        <button class="refresh-btn" onclick="refreshLeaderboard()">üîÑ Refresh</button>
                    </div>

                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Team Member</th>
                                <th>Total Submitted</th>
                                <th>Total Paid</th>
                                <th>Avg Case Size</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                                    <p>Loading team data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Right Column - Combined Goals Section -->
            <div class="right-column">
                <!-- Combined Team Target and User Yearly Goal Section -->
                <div class="combined-goals-section">
                    <!-- Team Monthly Goal -->
                    <div class="team-target-part">
                        <h3 id="team-target-title">üéØ Team Monthly Goal</h3>
                        <div class="target-progress" style="display:flex; align-items:center; gap:10px;">
                            <div class="progress-bar" style="flex:1;">
                                <div class="progress-fill" id="team-progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="target-percentage" id="team-progress"
                                style="min-width:3.5ch; text-align:right; font-weight:600;">0%</div>
                        </div>
                        <div class="target-details">
                            <div class="target-row">
                                <span>üéØ Start:</span>
                                <span>¬£0</span>
                            </div>
                            <div class="target-row">
                                <span>üìä Team Monthly Goal:</span>
                                <span><strong>¬£<span id="team-goal">50,000.00</span></strong></span>
                            </div>
                            <div class="target-row">
                                <span>üí∞ Team Total This Month:</span>
                                <span><strong>¬£<span id="team-submitted">0.00</span></strong></span>
                            </div>
                            <div class="target-row">
                                <span>üí∑ Team Remaining:</span>
                                <span>¬£<span id="team-remaining">0.00</span></span>
                            </div>
                            <div class="target-row">
                                <span>üìÖ Days Left in Month:</span>
                                <span><span id="days-left">0</span> days</span>
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="goals-divider"></div>

                    <!-- User Yearly Goal -->
                    <div class="user-yearly-goal-part">
                        <h4 style="color: var(--secondary-color); font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">üë§ Yearly Goal Progress</h4>
                        <div class="goal-progress" style="margin-bottom:1.2rem; display:flex; align-items:center; gap:10px;">
                            <div class="progress-bar" style="flex:1;">
                                <div class="progress-fill" id="user-yearly-progress-bar" style="width:0%"></div>
                            </div>
                            <div class="goal-percentage" id="user-yearly-progress"
                                style="min-width:3.5ch; text-align:right; font-weight:600;">0%</div>
                        </div>
                        <div class="goal-details">
                            <div class="goal-row">
                                <span>üéØ Yearly Goal:</span>
                                <span><strong>¬£<span id="user-yearly-goal">0.00</span></strong></span>
                            </div>
                            <div class="goal-row">
                                <span>üí∞ Total This Year:</span>
                                <span><strong>¬£<span id="user-yearly-submitted">0.00</span></strong></span>
                            </div>
                            <div class="goal-row">
                                <span>üí∑ Remaining:</span>
                                <span>¬£<span id="user-yearly-remaining">0.00</span></span>
                            </div>
                            <div class="goal-row">
                                <span>üìÖ Days Left in Year:</span>
                                <span><span id="user-days-left-year">365</span> days</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Full Width Cases Section -->
        <div class="cases-section-fullwidth">
            <div class="cases-header">
                <div class="cases-title">üìã Cases <span class="status-badge status-submitted" id="cases-count">0</span></div>
                <div class="cases-filters">
                    <button class="refresh-btn" onclick="refreshCases()">üîÑ Refresh</button>
                    <select class="filter-select" id="case-data-type" onchange="loadUserCases()">
                        <option value="submitted">Fee Submitted</option>
                        <option value="paid">Paid</option>
                    </select>
                    <select class="filter-select" id="case-type-filter" onchange="loadUserCases()">
                        <option value="all">All Case Types</option>
                        <!-- Dynamic options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <!-- Scrollable Table Container -->
            <div class="cases-table-container">
                <table class="cases-table">
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Case Type</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Data Type</th>
                        </tr>
                    </thead>
                    <tbody id="cases-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                                <p>Loading cases...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let advisorId = {{ advisor.id }};
        let currentPeriod = 'month';
        let currentChartType = 'submitted';
        let performanceChart = null;
        let customStartDate = null;
        let customEndDate = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure modal starts hidden
            const modal = document.getElementById('customDateModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
            
            setupEventListeners();
            updateCaseTypeFilter();
            loadDashboardData();
            loadUserGoalData();
            loadTeamData();
            loadUserCases();
            initializeChart();
            
            // Auto-refresh every minute
            setInterval(() => {
                loadDashboardData();
                loadUserGoalData();
                loadTeamData();
                loadUserCases();
                updateChart();
            }, 60000);
        });

        function setupEventListeners() {
            // Period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.dataset.period === 'custom') {
                        openDateModal();
                    } else {
                        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        const customBtn = document.querySelector('[data-period="custom"]');
                        const existingRange = customBtn.querySelector('.custom-date-range');
                        if (existingRange) {
                            existingRange.remove();
                        }
                        
                        currentPeriod = this.dataset.period;
                        loadDashboardData();
                        loadTeamData();
                        loadUserCases();
                        updateChart();
                    }
                });
            });

            // Chart type buttons
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentChartType = this.dataset.type;
                    updateChart();
                });
            });

            // Cases filters
            document.getElementById('case-data-type').addEventListener('change', loadUserCases);
            document.getElementById('case-type-filter').addEventListener('change', loadUserCases);
            
            // Set default date values
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        // Update period from header dropdown
        function updatePeriod() {
            currentPeriod = document.getElementById('period-selector').value;
            
            // Update active period button
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            const periodMapping = {
                'month': 'month',
                'quarter': 'quarter', 
                'year': 'year'
            };
            const activeBtn = document.querySelector(`[data-period="${periodMapping[currentPeriod] || 'month'}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            loadDashboardData();
            loadTeamData();
            loadUserCases();
            updateChart();
        }

        // Update case type filter based on current company
        function updateCaseTypeFilter() {
            const caseTypeFilter = document.getElementById('case-type-filter');
            const currentValue = caseTypeFilter.value;
            
            // Clear existing options except "All Case Types"
            caseTypeFilter.innerHTML = '<option value="all">All Case Types</option>';
            
            // Add company-specific case types - you can modify this based on your needs
            let caseTypes = [
                'Residential Mortgage (Including BTL)',
                'Personal Insurance (Including GI)',
                'Product Transfer',
                'Bridging or Development',
                'Commercial',
                '2nd Charge - Regulated',
                '2nd Charge - Unregulated',
                'Development',
                'Business Loan'
            ];
            
            caseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                caseTypeFilter.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (Array.from(caseTypeFilter.options).some(opt => opt.value === currentValue)) {
                caseTypeFilter.value = currentValue;
            } else {
                caseTypeFilter.value = 'all';
            }
        }

        // Date modal functions
        function openDateModal() {
            const modal = document.getElementById('customDateModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            
            setTimeout(() => {
                document.getElementById('startDate').focus();
            }, 100);
        }

        function closeDateModal() {
            const modal = document.getElementById('customDateModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            
            if (currentPeriod !== 'custom') {
                document.querySelector('[data-period="custom"]').classList.remove('active');
                const currentBtn = document.querySelector(`[data-period="${currentPeriod}"]`);
                if (currentBtn) {
                    currentBtn.classList.add('active');
                }
            }
        }

        function applyCustomDates() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }
            
            customStartDate = startDate;
            customEndDate = endDate;
            currentPeriod = 'custom';
            
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            const customBtn = document.querySelector('[data-period="custom"]');
            customBtn.classList.add('active');
            
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            const startFormatted = startDateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            const endFormatted = endDateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            
            let existingRange = customBtn.querySelector('.custom-date-range');
            if (!existingRange) {
                existingRange = document.createElement('span');
                existingRange.className = 'custom-date-range';
                customBtn.appendChild(existingRange);
            }
            existingRange.textContent = ` (${startFormatted} - ${endFormatted})`;
            
            closeDateModal();
            
            loadDashboardData();
            loadTeamData();
            loadUserCases();
            updateChart();
        }

        // Close modal when clicking outside or pressing Escape
        window.onclick = function(event) {
            const modal = document.getElementById('customDateModal');
            if (event.target === modal) {
                closeDateModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('customDateModal');
                if (modal && modal.style.display === 'block') {
                    closeDateModal();
                }
            }
        });

        // API Functions - Modified to use advisor-specific endpoints
        async function loadDashboardData() {
            try {
                let url = `/api/advisor-dashboard-data/${advisorId}?period=${currentPeriod}`;
                if (currentPeriod === 'custom' && customStartDate && customEndDate) {
                    url += `&start=${customStartDate}&end=${customEndDate}`;
                }
                
                const response = await fetch(url, { cache: 'no-store' });
                const data = await response.json();
                const totalProc = data.total_submitted - data.total_fee;

                document.getElementById('total-submitted').textContent = `¬£${data.total_submitted.toFixed(2)}`;
                document.getElementById('your-proc').textContent = totalProc.toFixed(2);
                document.getElementById('your-fee').textContent = data.total_fee.toFixed(2);
                document.getElementById('combined-total').textContent = data.combined_total.toFixed(2);
                document.getElementById('total-paid').textContent = `¬£${data.total_paid.toFixed(2)}`;
                document.getElementById('payment-percentage').textContent = Math.round(data.payment_percentage);
                document.getElementById('payment-progress').style.width = `${Math.min(data.payment_percentage, 100)}%`;
                
                const totalApps = Object.values(data.applications).reduce((sum, count) => sum + count, 0);
                document.getElementById('total-applications').textContent = totalApps;
                document.getElementById('avg-per-application').textContent = totalApps > 0 ? (data.combined_total / totalApps).toFixed(2) : '0.00';

                document.getElementById('referrals-made').textContent = data.referrals_made;
                document.getElementById('referrals-made-count').textContent = data.referrals_made;
                document.getElementById('referrals-received-count').textContent = data.referrals_received;

                const breakdown = Object.entries(data.applications)
                    .map(([type, count]) => `${type}: ${count}`)
                    .join(', ');
                document.getElementById('applications-breakdown').textContent = breakdown || 'No applications';

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadUserGoalData() {
            try {
                const response = await fetch(`/api/advisor-goal-data/${advisorId}`, { cache: 'no-store' });
                const data = await response.json();
                
                // Update user yearly goal display
                document.getElementById('user-yearly-progress').textContent = `${Math.round(data.user_yearly_progress)}%`;
                document.getElementById('user-yearly-progress-bar').style.width = `${Math.min(data.user_yearly_progress, 100)}%`;
                document.getElementById('user-yearly-goal').textContent = data.user_yearly_goal.toFixed(2);
                document.getElementById('user-yearly-submitted').textContent = data.user_yearly_total.toFixed(2);
                document.getElementById('user-yearly-remaining').textContent = data.user_yearly_remaining.toFixed(2);
                document.getElementById('user-days-left-year').textContent = data.days_left_year;
                
                // Update chart stats
                document.getElementById('yearly-goal').textContent = data.user_yearly_goal.toFixed(2);
                document.getElementById('yearly-progress').textContent = Math.round(data.user_yearly_progress);
                
                // Change color based on yearly progress
                const progressElement = document.getElementById('user-yearly-progress');
                const progressBar = document.getElementById('user-yearly-progress-bar');
                
                if (data.user_yearly_progress >= 100) {
                    progressElement.style.color = '#2ecc71';
                    progressBar.style.setProperty('--card-color', '#2ecc71');
                    progressBar.style.setProperty('--card-color-light', '#55efc4');
                } else if (data.user_yearly_progress >= 75) {
                    progressElement.style.color = '#f39c12';
                    progressBar.style.setProperty('--card-color', '#f39c12');
                    progressBar.style.setProperty('--card-color-light', '#fdcb6e');
                } else {
                    progressElement.style.color = '#667eea';
                    progressBar.style.setProperty('--card-color', '#667eea');
                    progressBar.style.setProperty('--card-color-light', '#a29bfe');
                }

            } catch (error) {
                console.error('Error loading user goal data:', error);
            }
        }

        async function loadTeamData() {
            try {
                let url = `/api/advisor-team-data/${advisorId}?period=${currentPeriod}`;
                if (currentPeriod === 'custom' && customStartDate && customEndDate) {
                    url += `&start=${customStartDate}&end=${customEndDate}`;
                }
                
                const response = await fetch(url, { cache: 'no-store' });
                const data = await response.json();
                
                const safeSetTextContent = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                };
                
                const safeSetStyle = (id, property, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style[property] = value;
                    }
                };
                
                if (data.no_team) {
                    safeSetTextContent('team-progress', '0%');
                    safeSetStyle('team-progress-bar', 'width', '0%');
                    safeSetTextContent('team-goal', '0.00');
                    safeSetTextContent('team-submitted', '0.00');
                    safeSetTextContent('team-remaining', '0.00');
                    safeSetTextContent('days-left', '0');

                    const leaderboardBody = document.getElementById('leaderboard-body');
                    if (leaderboardBody) {
                        leaderboardBody.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                                    <p>This advisor is not assigned to a team.</p>
                                </td>
                            </tr>
                        `;
                    }

                    const leaderboardTitle = document.querySelector('.leaderboard-title');
                    if (leaderboardTitle) {
                        leaderboardTitle.textContent = 'No Team Assigned';
                    }
                    
                    const teamTargetTitle = document.getElementById('team-target-title');
                    if (teamTargetTitle) {
                        teamTargetTitle.textContent = 'No Team Target';
                    }
                    return;
                }

                safeSetTextContent('team-progress', `${Math.round(data.team_progress)}%`);
                safeSetStyle('team-progress-bar', 'width', `${Math.min(data.team_progress, 100)}%`);
                safeSetTextContent('team-goal', data.team_monthly_goal.toFixed(2));
                safeSetTextContent('team-submitted', data.team_monthly_total.toFixed(2));
                safeSetTextContent('team-remaining', (data.team_monthly_goal - data.team_monthly_total).toFixed(2));
                safeSetTextContent('days-left', `${data.days_left}`);

                const leaderboardBody = document.getElementById('leaderboard-body');
                if (leaderboardBody) {
                    leaderboardBody.innerHTML = '';

                    if (data.team_members.length === 0) {
                        leaderboardBody.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: #7f8c8d;">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                                    <p>No team members found.</p>
                                </td>
                            </tr>
                        `;
                    } else {
                        // Sort team members by total submitted (descending)
                        data.team_members.sort((a, b) => b.total_submitted - a.total_submitted);
                        
                        data.team_members.forEach((member, index) => {
                            const row = document.createElement('tr');
                            if (member.name === '{{ advisor.full_name }}') {
                                row.style.background = 'linear-gradient(135deg, #fff9e6 0%, #fff3d6 100%)';
                                row.style.borderLeft = '4px solid #f39c12';
                            }

                            const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : 'rank-other';
                            
                            row.innerHTML = `
                                <td><span class="rank-badge ${rankClass}">#${index + 1}</span></td>
                                <td>
                                    <strong>${member.name}</strong>
                                    ${member.name === '{{ advisor.full_name }}' ? '<span class="status-badge status-submitted" style="margin-left: 0.5rem;">This User</span>' : ''}
                                </td>
                                <td><strong>¬£${member.total_submitted.toFixed(2)}</strong></td>
                                <td style="color: #2ecc71;"><strong>¬£${member.total_paid.toFixed(2)}</strong></td>
                                <td>¬£${member.avg_case_size.toFixed(2)}</td>
                            `;
                            leaderboardBody.appendChild(row);
                        });
                    }
                }

                const leaderboardTitle = document.querySelector('.leaderboard-title');
                if (leaderboardTitle) {
                    leaderboardTitle.textContent = `üèÜ ${data.team_name} Leaderboard (${data.team_members.length} members)`;
                }
                
                const teamTargetTitle = document.getElementById('team-target-title');
                if (teamTargetTitle) {
                    teamTargetTitle.textContent = `üéØ ${data.team_name} Target (Current Month)`;
                }

            } catch (error) {
                console.error('Error loading team data:', error);
                const leaderboardTitle = document.querySelector('.leaderboard-title');
                if (leaderboardTitle) {
                    leaderboardTitle.textContent = 'Team Data Unavailable';
                }
                
                const leaderboardBody = document.getElementById('leaderboard-body');
                if (leaderboardBody) {
                    leaderboardBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: #e74c3c;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                                <p>Error loading team data. Please try again later.</p>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        async function loadUserCases() {
            try {
                const dataType = document.getElementById('case-data-type').value;
                const caseType = document.getElementById('case-type-filter').value;
                
                const casesBody = document.getElementById('cases-body');
                casesBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="cases-loading">
                            <div>üìä Loading cases...</div>
                        </td>
                    </tr>
                `;
                
                let url = `/api/advisor-cases/${advisorId}?data_type=${dataType}&case_type=${caseType}&period=${currentPeriod}`;
                if (currentPeriod === 'custom' && customStartDate && customEndDate) {
                    url += `&start=${customStartDate}&end=${customEndDate}`;
                }
                
                const response = await fetch(url, { cache: 'no-store' });
                const cases = await response.json();
                
                casesBody.innerHTML = '';

                if (cases.length === 0) {
                    casesBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="cases-empty">
                                <div class="cases-empty-icon">üìã</div>
                                <div><strong>No cases found</strong></div>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                                    Try adjusting your filters or date range
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    cases.forEach((caseItem, index) => {
                        const row = document.createElement('tr');
                        const statusClass = caseItem.payment_status === 'Paid' ? 'status-paid' : 
                                        caseItem.payment_status === 'Pending' ? 'status-pending' : 'status-submitted';
                        
                        row.innerHTML = `
                            <td title="${caseItem.customer_name}">${caseItem.customer_name}</td>
                            <td>
                                <span>${caseItem.case_type}</span>
                            </td>
                            <td style="font-weight: 600; color: #2c3e50;">¬£${caseItem.fee_submitted.toFixed(2)}</td>
                            <td><span class="status-badge ${statusClass}">${caseItem.payment_status}</span></td>
                            <td style="font-weight: 500;">${caseItem.date}</td>
                            <td><span class="status-badge status-submitted">${caseItem.data_type}</span></td>
                        `;
                        casesBody.appendChild(row);
                    });
                }

                document.querySelector('.cases-title span').textContent = cases.length;

                if (cases.length > 8) {
                    const container = document.querySelector('.cases-table-container');
                    container.title = `${cases.length} cases - scroll to see more`;
                }

            } catch (error) {
                console.error('Error loading user cases:', error);
                
                const casesBody = document.getElementById('cases-body');
                casesBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="cases-empty">
                            <div class="cases-empty-icon">‚ö†Ô∏è</div>
                            <div><strong>Error loading cases</strong></div>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                                Please try again or contact support
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        async function initializeChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
                performanceChart = null;
            }
            
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Performance',
                        data: [],
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: '#3498db',
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false,
                    }, {
                        label: 'Monthly Goal',
                        data: [],
                        type: 'line',
                        borderColor: '#e74c3c',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `${context.dataset.label}: ¬£${context.parsed.y.toLocaleString()}`;
                                    } else {
                                        return `${context.dataset.label}: ¬£${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¬£' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            updateChart();
        }

        async function updateChart() {
            if (!performanceChart) {
                console.warn('Chart not initialized, calling initializeChart()');
                await initializeChart();
                return;
            }

            try {
                // Use the same boxplot endpoint as the main dashboard but for specific advisor
                let url = `/api/advisor-performance-boxplot/${advisorId}?period=${currentPeriod}&type=${currentChartType}`;
                if (currentPeriod === 'custom' && customStartDate && customEndDate) {
                    url += `&start=${customStartDate}&end=${customEndDate}`;
                }
                
                const response = await fetch(url, { cache: 'no-store' });
                const data = await response.json();

                // Update chart data with aggregated periods (weekly/monthly)
                performanceChart.data.labels = data.periods;
                performanceChart.data.datasets[0].data = data.values;
                performanceChart.data.datasets[0].label = currentChartType === 'submitted' ? 'Total Submitted' : 'Total Paid';
                performanceChart.data.datasets[0].backgroundColor = currentChartType === 'submitted' ? 'rgba(52, 152, 219, 0.8)' : 'rgba(46, 204, 113, 0.8)';
                performanceChart.data.datasets[0].borderColor = currentChartType === 'submitted' ? '#3498db' : '#2ecc71';
                
                // Update goal line with monthly goals
                performanceChart.data.datasets[1].data = data.monthly_goals;
                
                performanceChart.update();

                // Update stats
                const total = data.current_total || 0;
                const best = Math.max(...data.values, 0);
                const monthlyGoal = data.monthly_goal || 0;
                
                document.getElementById('chart-total').textContent = total.toFixed(2);
                document.getElementById('chart-best').textContent = best.toFixed(2);

            } catch (error) {
                console.error('Error updating chart:', error);
                // Fallback to original timeline if boxplot fails
                await updateOriginalChart();
            }
        }

        // Fallback to original chart format if boxplot endpoint doesn't exist
        async function updateOriginalChart() {
            try {
                let url = `/api/advisor-performance-timeline/${advisorId}?period=${currentPeriod}&type=${currentChartType}`;
                if (currentPeriod === 'custom' && customStartDate && customEndDate) {
                    url += `&start=${customStartDate}&end=${customEndDate}`;
                }
                
                const response = await fetch(url, { cache: 'no-store' });
                const data = await response.json();

                // Convert line chart to bar chart data
                const periods = data.map(item => new Date(item.date).toLocaleDateString());
                const values = data.map(item => item.value);
                
                performanceChart.data.labels = periods.slice(-10); // Show last 10 data points
                performanceChart.data.datasets[0].data = values.slice(-10);
                performanceChart.data.datasets[1].data = Array(Math.min(periods.length, 10)).fill(0);
                
                performanceChart.update();

                const total = data.length > 0 ? data[data.length - 1].value : 0;
                const best = Math.max(...values, 0);
                document.getElementById('chart-total').textContent = total.toFixed(2);
                document.getElementById('chart-best').textContent = best.toFixed(2);

            } catch (error) {
                console.error('Error with fallback chart:', error);
            }
        }

        function refreshLeaderboard() {
            loadTeamData();
        }

        function refreshCases() {
            loadUserCases();
        }
    </script>
</body>
</html>