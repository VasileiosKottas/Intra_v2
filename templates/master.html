<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Dashboard - Sales Team</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/master.css') }}">
</head>
<body>
    <div class="header">
        <h1>Suite Master <span class="company-indicator" id="company-indicator">{{ company_config.name }}</span></h1>
        <div class="user-info">
            <select id="company-selector" class="company-selector" onchange="switchCompany()">
                <option value="windsor" {{ 'selected' if session.get('company_mode', 'windsor') == 'windsor' else '' }}>Windsor</option>
                <option value="cnc" {{ 'selected' if session.get('company_mode', 'windsor') == 'cnc' else '' }}>C&C</option>
            </select>
            <span>Welcome, Master Administrator!</span>
            <a href="/logout" class="logout-btn">Logout</a>

        </div>
    </div>

    <div class="main-content">
        <div class="dashboard-header">
            <div>
                <h2 class="dashboard-title">Master Dashboard</h2>
                <p style="color: #7f8c8d; margin-top: 0.5rem;">Company-wide overview and team management for {{ company_config.name }}</p>
            </div>
            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="openCreateTeamModal()">
                    ➕ Create Team
                </button>
                <button class="action-btn btn-secondary" onclick="openAssignModal()">
                    👥 Assign to Team
                </button>
                <button class="action-btn btn-info" onclick="syncData()">
                    🔄 Sync Data
                </button>
            </div>
        </div>

        <div class="content-grid">
            <!-- Teams Section -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">🏢 Teams ({{ teams|length }})</h3>
                </div>

                {% for team in teams %}
                <div class="team-card">
                    <div class="team-header">
                        <span class="team-name">
                            {{ team.name }}
                            {% if team.is_hidden %}
                            <span class="hidden-team-indicator">🔒 Hidden</span>
                            {% endif %}
                        </span>
                        <div class="team-actions">
                            <span style="color: #7f8c8d; font-size: 0.9rem; margin-right: 1rem;">
                                Monthly Goal: £{{ "{:,.2f}".format(team.monthly_goal) }}
                            </span>
                            <!-- Team Performance Options -->
                            <div class="dropdown" style="display: inline-block; position: relative; margin-right: 0.5rem;">
                                <button class="btn-sm" style="background: #17a2b8; color: white;" 
                                        onclick="toggleDropdown({{ team.id }})">
                                    📊 Performance Report ▼
                                </button>
                                <div class="dropdown-content" id="dropdown-{{ team.id }}" style="display: none; position: absolute; background: white; min-width: 200px; box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 6px; padding: 8px 0;">

                                    <a href="#" onclick="openYTDDashboard({{ team.id }}, '{{ team.name }}')" 
                                    style="display: block; padding: 8px 16px; text-decoration: none; color: #2c3e50;">📊 YTD Dashboard</a>
                                </div>
                            </div>
                            <button class="btn-sm btn-edit" onclick="editTeam({{ team.id }}, '{{ team.name }}', {{ team.monthly_goal }}, {{ team.is_hidden|tojson }})">
                                ✏️ Edit
                            </button>
                            <button class="btn-sm btn-delete" onclick="deleteTeam({{ team.id }}, '{{ team.name }}')">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                    <div class="team-members">
                        {% for member in team.members %}
                        <div class="member-item">
                            <span>
                                <a href="/master/advisor/{{ member.id }}" style="text-decoration: none; color: #2c3e50; font-weight: 500;">
                                    {{ member.full_name }}
                                </a>
                                {% if team.is_hidden %}
                                <span class="status-badge status-hidden">Hidden Team</span>
                                {% else %}
                                <span class="status-badge status-assigned">Team Member</span>
                                {% endif %}
                                <!-- Individual advisor visibility status -->
                                {% if member.is_hidden_from_team %}
                                <span class="status-badge status-individual-hidden">Hidden from Team</span>
                                {% endif %}
                                
                                <!-- Show if member is in multiple teams -->
                                {% set member_teams = member.get_teams_for_company(session.get('company_mode', 'windsor')) %}
                                {% if member_teams|length > 1 %}
                                <span class="status-badge" style="background: #17a2b8; color: white; font-size: 0.7rem;">
                                    {{ member_teams|length }} Teams
                                </span>
                                {% endif %}
                            </span>
                            <div class="member-actions">
                                <span class="goal-display">
                                    £{{ "{:,.0f}".format(member.get_yearly_goal_for_company(session.get('company_mode', 'windsor'))) }}
                                </span>
                                <button class="btn-sm btn-view" onclick="viewAdvisorDashboard({{ member.id }})">
                                    👁️ View
                                </button>
                                <!-- Hide/Show button for individual advisors -->
                                {% if not member.is_master %}
                                <button class="btn-sm btn-hide-advisor" 
                                        id="hide-btn-{{ member.id }}"
                                        onclick="toggleAdvisorVisibility({{ member.id }}, '{{ member.full_name }}')"
                                        style="background: {% if member.is_hidden_from_team %}#28a745{% else %}#ffc107{% endif %}; 
                                            color: {% if member.is_hidden_from_team %}white{% else %}#212529{% endif %};">
                                    {% if member.is_hidden_from_team %}
                                        👁️ Show
                                    {% else %}
                                        🙈 Hide
                                    {% endif %}
                                </button>
                                {% endif %}
                                
                                <button class="btn-sm btn-edit" onclick="setAdvisorGoal({{ member.id }}, '{{ member.full_name }}', {{ member.get_yearly_goal_for_company(session.get('company_mode', 'windsor')) }})">
                                    ✏️ Edit
                                </button>
                                <button class="btn-sm btn-remove" onclick="removeFromTeam({{ member.id }}, {{ team.id }}, '{{ member.full_name }}', '{{ team.name }}')">
                                    ❌ Remove
                                </button>
                                <button class="btn-sm btn-goal" onclick="editAdvisorGoal({{ member.id }}, '{{ member.full_name }}', {{ member.get_yearly_goal_for_company(session.get('company_mode', 'windsor')) }})">
                                    🎯 Goal
                                </button>
                                <button class="btn-sm" style="background: #17a2b8; color: white;" onclick="editUserCredentials({{ member.id }}, '{{ member.full_name }}')">
                                    ⚙️ Creds
                                </button>
                                <button class="btn-sm" style="background: #fd7e14; color: white;" onclick="resetUserPassword({{ member.id }}, '{{ member.full_name }}')">
                                    🔑 Reset
                                </button>
                                <!-- Remove from THIS specific team -->
                                <button class="btn-sm btn-unassign" onclick="unassignFromSpecificTeam({{ member.id }}, '{{ member.full_name }}', {{ team.id }}, '{{ team.name }}')">
                                    ❌ Remove
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        {% if team.members|length == 0 %}
                        <div style="color: #7f8c8d; font-style: italic; text-align: center; padding: 1rem;">
                            No members assigned
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- All Advisors Section - Updated to show multiple team memberships -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">👥 All Advisors</h3>
                    <span style="color: #7f8c8d; font-size: 0.9rem;">
                        {{ all_advisor_names|length }} total
                    </span>
                </div>

                {% for advisor_name in all_advisor_names %}
                {% set registered_advisor = advisors|selectattr('full_name', 'equalto', advisor_name)|first %}
                <div class="advisor-card" {% if registered_advisor %}onclick="viewAdvisorDashboard({{ registered_advisor.id }})"{% endif %}>
                    <div class="advisor-info">
                        <div class="advisor-name">{{ advisor_name }}</div>
                        <div class="advisor-details">
                            {% if registered_advisor %}
                                <span class="status-badge status-registered">Registered</span>
                                
                                <!-- UPDATED: Show ALL teams for this advisor -->
                                {% set current_teams = registered_advisor.get_teams_for_company(session.get('company_mode', 'windsor')) %}
                                {% if current_teams %}
                                    {% for team in current_teams %}
                                        {% if team.is_hidden %}
                                            <span class="status-badge status-hidden">{{ team.name }} (Hidden)</span>
                                        {% else %}
                                            <span class="status-badge status-assigned">{{ team.name }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Show count if multiple teams -->
                                    {% if current_teams|length > 1 %}
                                        <span class="status-badge" style="background: #17a2b8; color: white; margin-left: 0.5rem;">
                                            {{ current_teams|length }} Teams Total
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #f39c12; margin-left: 0.5rem;">No Team - Individual Goals</span>
                                {% endif %}
                                
                                <span class="goal-display" style="margin-left: 0.5rem;">
                                    £{{ "{:,.0f}".format(registered_advisor.get_yearly_goal_for_company(session.get('company_mode', 'windsor'))) }}
                                </span>
                            {% else %}
                                <span class="status-badge status-unregistered">Not Registered</span>
                                <span style="color: #7f8c8d; margin-left: 0.5rem;">
                                    No account created yet
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="advisor-actions" onclick="event.stopPropagation();">
                        {% if registered_advisor %}
                            <button class="btn-sm btn-view" onclick="viewAdvisorDashboard({{ registered_advisor.id }})">
                                👁️ View
                            </button>
                            <button class="btn-sm btn-goal" onclick="editAdvisorGoal({{ registered_advisor.id }}, '{{ registered_advisor.full_name }}', {{ registered_advisor.get_yearly_goal_for_company(session.get('company_mode', 'windsor')) }})">
                                🎯 Goal
                            </button>
                            <button class="btn-sm" style="background: #17a2b8; color: white;" onclick="editUserCredentials({{ registered_advisor.id }}, '{{ registered_advisor.full_name }}')">
                                ⚙️ Credentials
                            </button>
                            <button class="btn-sm" style="background: #fd7e14; color: white;" onclick="resetUserPassword({{ registered_advisor.id }}, '{{ registered_advisor.full_name }}')">
                                🔑 Reset PW
                            </button>
                            
                            <!-- UPDATED: Show assign/manage teams button -->
                            {% set current_teams = registered_advisor.get_teams_for_company(session.get('company_mode', 'windsor')) %}
                            <button class="btn-sm btn-assign" onclick="quickAssign({{ registered_advisor.id }}, '{{ registered_advisor.full_name }}')">
                                👥 Add to Team
                            </button>
                            
                            {% if current_teams %}
                                <button class="btn-sm" style="background: #dc3545; color: white;" onclick="manageTeamMemberships({{ registered_advisor.id }}, '{{ registered_advisor.full_name }}')">
                                    ❌ Manage Teams
                                </button>
                            {% endif %}
                        {% else %}
                            <span style="color: #7f8c8d; font-size: 0.8rem;">
                                Waiting for registration
                            </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- NEW: Team Management Modal for Multiple Memberships -->
            <div id="teamManagementModal" class="modal">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Manage Team Memberships</h3>
                        <button class="close-modal" onclick="closeModal('teamManagementModal')">&times;</button>
                    </div>
                    
                    <div id="teamManagementContent">
                        <div style="margin-bottom: 1.5rem;">
                            <p><strong>Advisor:</strong> <span id="managingAdvisorName"></span></p>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Current teams and membership management</p>
                        </div>
                        
                        <div id="currentTeamsList">
                            <!-- Dynamic content will be populated here -->
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                            <h4 style="margin-bottom: 1rem;">Add to New Team</h4>
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select Team</label>
                                    <select id="addTeamSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Choose team to add...</option>
                                    </select>
                                </div>
                                <button class="btn-sm btn-primary" onclick="addToTeam()">Add</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-buttons" style="margin-top: 2rem;">
                        <button type="button" class="btn-cancel" onclick="closeModal('teamManagementModal')">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Referral Recipients Section - Smaller box at bottom -->
        <div class="referral-recipients-bottom">
            <div class="section-card referral-compact">
                <div class="section-header">
                    <h3 class="section-title">🔄 Referral Recipients</h3>
                    <button class="action-btn btn-primary btn-sm" onclick="openReferralModal()">
                        ➕ Manage
                    </button>
                </div>

                <div id="referral-recipients-list">
                    <div style="text-align: center; padding: 1rem; color: #7f8c8d;">
                        Loading referral recipients...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div id="createTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Team</h3>
                <button class="close-modal" onclick="closeModal('createTeamModal')">×</button>
            </div>
            <form id="createTeamForm">
                <div class="form-group">
                    <label class="form-label" for="teamName">Team Name</label>
                    <input type="text" id="teamName" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="monthlyGoal">Monthly Goal (£)</label>
                    <input type="number" id="monthlyGoal" name="monthly_goal" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="isHidden" name="is_hidden">
                        <label for="isHidden">Hidden Team (members can't see each other in leaderboards)</label>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal('createTeamModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Create Team</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Team Modal -->
    <div id="editTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Team</h3>
                <button class="close-modal" onclick="closeModal('editTeamModal')">×</button>
            </div>
            <form id="editTeamForm">
                <input type="hidden" id="editTeamId" name="team_id">
                <div class="form-group">
                    <label class="form-label" for="editTeamName">Team Name</label>
                    <input type="text" id="editTeamName" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="editMonthlyGoal">Monthly Goal (£)</label>
                    <input type="number" id="editMonthlyGoal" name="monthly_goal" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="editIsHidden" name="is_hidden">
                        <label for="editIsHidden">Hidden Team (members can't see each other in leaderboards)</label>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal('editTeamModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Update Team</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Advisor Goal Modal -->
    <div id="editGoalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Yearly Goal</h3>
                <button class="close-modal" onclick="closeModal('editGoalModal')">×</button>
            </div>
            <form id="editGoalForm">
                <input type="hidden" id="editGoalAdvisorId" name="advisor_id">
                <div class="form-group">
                    <label class="form-label" for="editGoalAdvisorName">Advisor</label>
                    <input type="text" id="editGoalAdvisorName" class="form-input" readonly style="background-color: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label class="form-label" for="editYearlyGoal">Yearly Goal (£)</label>
                    <input type="number" id="editYearlyGoal" name="yearly_goal" class="form-input" step="0.01" required>
                    <small style="color: #7f8c8d; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                        This goal applies to the current company: <strong id="goalCompanyName"></strong>
                    </small>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal('editGoalModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Update Goal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign to Team Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Assign to Team</h3>
                <button class="close-modal" onclick="closeModal('assignModal')">×</button>
            </div>
            <form id="assignForm">
                <div class="form-group">
                    <label class="form-label" for="advisorSelect">Select Advisor</label>
                    <select id="advisorSelect" name="advisor_id" class="form-select" required>
                        <option value="">Choose advisor...</option>
                        {% for advisor in advisors %}
                        <option value="{{ advisor.id }}">{{ advisor.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="teamSelect">Select Team</label>
                    <select id="teamSelect" name="team_id" class="form-select" required>
                        <option value="">Choose team...</option>
                        {% for team in teams %}
                        <option value="{{ team.id }}">{{ team.name }}{% if team.is_hidden %} (Hidden){% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="yearlyGoal">Yearly Goal (£)</label>
                    <input type="number" id="yearlyGoal" name="yearly_goal" class="form-input" step="0.01" required>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal('assignModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Assign to Team</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Referral Management Modal -->
    <div id="referralModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Referral System</h3>
                <button class="close-modal" onclick="closeModal('referralModal')">×</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('recipients')">Recipients</button>
                <button class="tab-btn" onclick="switchTab('mappings')">Name Mappings</button>
                <button class="tab-btn" onclick="switchTab('unmapped')">Unmapped Referrals</button>
            </div>

            <!-- Recipients Tab -->
            <div id="recipients-tab" class="tab-content active">
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #7f8c8d; font-size: 0.9rem;">
                        Select advisors who can receive referrals. These advisors will see "referrals received" counts in their dashboard.
                    </p>
                </div>
                
                <div id="referral-advisor-list">
                    <!-- Dynamic content will be populated here -->
                </div>
            </div>

            <!-- Name Mappings Tab -->
            <div id="mappings-tab" class="tab-content">
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #7f8c8d; font-size: 0.9rem;">
                        Map referral names from submissions to actual advisors. This helps the system recognize when referrals are made to specific people.
                    </p>
                    <button class="btn-sm btn-primary" onclick="showAddMappingForm()">➕ Add New Mapping</button>
                </div>

                <!-- Add Mapping Form -->
                <div id="add-mapping-form" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 1rem; color: #2c3e50;">Add New Mapping</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Referral Name</label>
                            <input type="text" id="new-referral-name" placeholder="e.g., Steve/Protection" 
                                style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Maps to Advisor</label>
                            <select id="new-mapping-advisor" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select advisor...</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-sm btn-primary" onclick="addMapping()">Add</button>
                            <button class="btn-sm btn-cancel" onclick="hideAddMappingForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Mappings List -->
                <div id="mappings-list">
                    <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                        Loading mappings...
                    </div>
                </div>
            </div>

            <!-- Unmapped Referrals Tab -->
            <div id="unmapped-tab" class="tab-content">
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #7f8c8d; font-size: 0.9rem;">
                        These are referral names found in your submissions that don't have mappings yet. Click on any to quickly create a mapping.
                    </p>
                    <button class="btn-sm btn-secondary" onclick="loadUnmappedReferrals()">🔄 Refresh</button>
                </div>

                <div id="unmapped-list">
                    <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                        Loading unmapped referrals...
                    </div>
                </div>
            </div>
            
            <div class="form-buttons" style="margin-top: 2rem;">
                <button type="button" class="btn-cancel" onclick="closeModal('referralModal')">Close</button>
                <button type="button" class="btn-submit" onclick="saveReferralSettings()" id="save-recipients-btn">Save Recipients</button>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User Credentials</h3>
                <button class="close-modal" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="user_id">
                <div class="form-group">
                    <label class="form-label" for="editUserFullName">Full Name</label>
                    <input type="text" id="editUserFullName" class="form-input" readonly style="background-color: #f8f9fa; color: #6c757d;">
                </div>
                <div class="form-group">
                    <label class="form-label" for="editUserUsername">Username</label>
                    <input type="text" id="editUserUsername" name="username" class="form-input" required>
                    <small style="color: #7f8c8d; font-size: 0.85rem;">Must be unique across all users</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="editUserEmail">Email</label>
                    <input type="email" id="editUserEmail" name="email" class="form-input" required>
                    <small style="color: #7f8c8d; font-size: 0.85rem;">Must be unique across all users</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="editUserPassword">New Password (Optional)</label>
                    <input type="password" id="editUserPassword" name="password" class="form-input" placeholder="Leave blank to keep current password">
                    <small style="color: #7f8c8d; font-size: 0.85rem;">Only enter if you want to change the password</small>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal('editUserModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Update Credentials</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reset Password</h3>
                <button class="close-modal" onclick="closeModal('resetPasswordModal')">&times;</button>
            </div>
            <form id="resetPasswordForm">
                <input type="hidden" id="resetUserId" name="user_id">
                <div class="form-group">
                    <label class="form-label" for="resetUserName">User</label>
                    <input type="text" id="resetUserName" class="form-input" readonly style="background-color: #f8f9fa; color: #6c757d;">
                </div>
                <div class="form-group">
                    <label class="form-label" for="resetNewPassword">New Password</label>
                    <input type="text" id="resetNewPassword" name="password" class="form-input" value="password123" required>
                    <small style="color: #7f8c8d; font-size: 0.85rem;">User should change this after first login</small>
                </div>
                <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                    <strong>⚠️ Warning:</strong> This will immediately change the user's password. They will need to use the new password to log in.
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal('resetPasswordModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Reset Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Email Configuration Section - Add this to your master dashboard -->
    <div class="dashboard-section email-reports-section">
        <h2 class="section-title">
            <i class="fas fa-envelope-open-text"></i>
            Automated Email Reports
        </h2>
        
        <div class="email-controls-grid">
            <!-- Quick Team Selection -->
            <div class="team-selector-card">
                <div class="card-header">
                    <h3><i class="fas fa-users"></i> Select Team for Reports</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="report-team-select">Choose Team:</label>
                        <select id="report-team-select" class="form-control">
                            <option value="">Select a team...</option>
                            <!-- Teams will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="quick-actions">
                        <button id="send-immediate-report" class="btn btn-primary" disabled>
                            <i class="fas fa-paper-plane"></i> Send Report Now
                        </button>
                        <button id="configure-team-email" class="btn btn-secondary" disabled>
                            <i class="fas fa-cog"></i> Configure Email
                        </button>
                    </div>
                    
                    <div id="team-email-status" class="email-status-info" style="display: none;">
                        <!-- Team email status will be shown here -->
                    </div>
                </div>
            </div>
            
            <!-- Email Reports Summary -->
            <div class="email-summary-card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> Email Reports Status</h3>
                </div>
                <div class="card-body">
                    <div class="status-metrics">
                        <div class="metric">
                            <div class="metric-value" id="enabled-teams-count">0</div>
                            <div class="metric-label">Teams with Email Enabled</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="scheduler-status-indicator">●</div>
                            <div class="metric-label">Scheduler Status</div>
                        </div>
                    </div>
                    
                    <div class="next-reports" id="next-reports-info">
                        <h4>Next Scheduled Reports:</h4>
                        <div id="next-reports-list">
                            <!-- Next scheduled reports will be listed here -->
                        </div>
                    </div>
                    
                    <div class="email-actions">
                        <a href="/master/email-config" class="btn btn-primary">
                            <i class="fas fa-envelope-open-text"></i> Manage Email Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCompany = '{{ session.get("company_mode", "windsor") }}';
        let referralRecipients = [];
        let advisorsList = [];
        let currentTab = 'recipients';
        let referralMappings = [];
        let unmappedReferrals = [];
        let teams = [];
        let emailConfigurations = {};
        // Company switching function
        async function switchCompany() {
            const selector = document.getElementById('company-selector');
            const newCompany = selector.value;
            
            if (newCompany === currentCompany) return;
            
            try {
                const response = await fetch('/api/set-company', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ company: newCompany })
                });
                
                if (response.ok) {
                    currentCompany = newCompany;
                    document.getElementById('company-indicator').textContent = newCompany.toUpperCase();
                    
                    // Reload referral data for new company
                    loadReferralRecipients();
                    
                    // Reload the page to show data for the new company
                    window.location.reload();
                } else {
                    console.error('Failed to switch company');
                    selector.value = currentCompany; // Revert selection
                }
            } catch (error) {
                console.error('Error switching company:', error);
                selector.value = currentCompany; // Revert selection
            }
        }

        // View advisor dashboard function
        function viewAdvisorDashboard(advisorId) {
            window.open(`/master/advisor/${advisorId}`, '_blank');
        }

        // Modal management
        function openCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'block';
        }

        function openAssignModal() {
            document.getElementById('assignModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Edit team function
        function editTeam(teamId, teamName, monthlyGoal, isHidden) {
            document.getElementById('editTeamId').value = teamId;
            document.getElementById('editTeamName').value = teamName;
            document.getElementById('editMonthlyGoal').value = monthlyGoal;
            document.getElementById('editIsHidden').checked = isHidden;
            document.getElementById('editTeamModal').style.display = 'block';
        }

        // Edit advisor goal function
        function editAdvisorGoal(advisorId, advisorName, currentGoal) {
            document.getElementById('editGoalAdvisorId').value = advisorId;
            document.getElementById('editGoalAdvisorName').value = advisorName;
            document.getElementById('editYearlyGoal').value = currentGoal;
            document.getElementById('goalCompanyName').textContent = currentCompany.toUpperCase();
            document.getElementById('editGoalModal').style.display = 'block';
        }

        // Delete team function
        async function deleteTeam(teamId, teamName) {
            if (confirm(`Are you sure you want to delete the team "${teamName}"? This will unassign all members from this team and cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/delete-team/${teamId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message);
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error deleting team: ' + (errorData.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Error deleting team: ' + error.message);
                }
            }
        }

        function toggleDropdown(teamId) {
            // Close all other dropdowns first
            document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                if (dropdown.id !== `dropdown-${teamId}`) {
                    dropdown.style.display = 'none';
                }
            });
            
            // Toggle this dropdown
            const dropdown = document.getElementById(`dropdown-${teamId}`);
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });        

        function openTeamPerformanceReport(teamId, teamName) {
            // Close dropdown
            document.getElementById(`dropdown-${teamId}`).style.display = 'none';
            
            // Open the team performance report page with the specific team ID
            const url = `/master/team-performance-report?team_id=${teamId}&team_name=${encodeURIComponent(teamName)}`;
            window.open(url, '_blank');
        }

        function downloadTeamExcel(teamId, teamName) {
            // Close dropdown
            document.getElementById(`dropdown-${teamId}`).style.display = 'none';
            
            // Get current month or let user select
            const month = new Date().toISOString().slice(0, 7); // YYYY-MM format
            
            // You could add a month selector here, but for now use current month
            const url = `/master/team-performance-excel/${teamId}?month=${month}`;
            
            // Create a temporary link to trigger download
            const link = document.createElement('a');
            link.href = url;
            link.download = `${teamName}_Performance_Report.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show feedback
            showSuccess(`Downloading ${teamName} performance report for ${new Date().toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}`);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Form submissions
        document.getElementById('createTeamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Convert checkbox to boolean
            data.is_hidden = document.getElementById('isHidden').checked;
            
            try {
                const response = await fetch('/api/create-team', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const errorData = await response.json();
                    alert('Error creating team: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error creating team: ' + error.message);
            }
        });

        document.getElementById('editTeamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const teamId = data.team_id;
            
            // Convert checkbox to boolean
            data.is_hidden = document.getElementById('editIsHidden').checked;
            delete data.team_id; // Remove from data object
            
            try {
                const response = await fetch(`/api/edit-team/${teamId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    location.reload();
                } else {
                    const errorData = await response.json();
                    alert('Error updating team: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error updating team: ' + error.message);
            }
        });

        // Edit advisor goal form submission
        document.getElementById('editGoalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/update-advisor-goal', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        advisor_id: parseInt(data.advisor_id),
                        yearly_goal: parseFloat(data.yearly_goal),
                        company: currentCompany
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    closeModal('editGoalModal');
                    location.reload();
                } else {
                    const errorData = await response.json();
                    alert('Error updating goal: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error updating goal: ' + error.message);
            }
        });

        document.getElementById('assignForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/assign-to-team', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    location.reload();
                } else {
                    const errorData = await response.json();
                    alert('Error assigning to team: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error assigning to team: ' + error.message);
            }
        });

        // Unassign from team
        async function unassignFromTeam(advisorId, advisorName) {
            if (confirm(`Are you sure you want to unassign ${advisorName} from their team in ${currentCompany.toUpperCase()}?`)) {
                try {
                    const response = await fetch('/api/unassign-from-team', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            advisor_id: advisorId
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message);
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error unassigning from team: ' + (errorData.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        // Quick assign function
        async function quickAssign(advisorId, advisorName) {
            const teamId = prompt(`Enter team ID to assign ${advisorName} to:`);
            const yearlyGoal = prompt('Enter yearly goal (£):');
            
            if (teamId && yearlyGoal) {
                try {
                    const response = await fetch('/api/assign-to-team', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            advisor_id: advisorId,
                            team_id: parseInt(teamId),
                            yearly_goal: parseFloat(yearlyGoal)
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message);
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error assigning to team: ' + (errorData.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        // Sync data
        async function syncData() {
            const confirmSync = confirm(`This will sync all data from JotForm for ${currentCompany.toUpperCase()}. Continue?`);
            if (!confirmSync) return;
            
            try {
                const response = await fetch('/api/sync-now', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Data sync completed successfully for ' + currentCompany.toUpperCase() + '!');
                } else {
                    const errorData = await response.json();
                    alert('Error syncing data: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error syncing data: ' + error.message);
            }
        }

        // REFERRAL MANAGEMENT FUNCTIONS
        async function loadReferralRecipients() {
            try {
                const response = await fetch('/api/referral-recipients');
                if (response.ok) {
                    referralRecipients = await response.json();
                    displayReferralRecipients();
                } else {
                    console.error('Failed to load referral recipients');
                    document.getElementById('referral-recipients-list').innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: #e74c3c;">
                            Error loading referral recipients
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading referral recipients:', error);
                document.getElementById('referral-recipients-list').innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #e74c3c;">
                        Error loading referral recipients
                    </div>
                `;
            }
        }

        function openYTDDashboard(teamId, teamName) {
            document.getElementById(`dropdown-${teamId}`).style.display = 'none';
            const url = `/master/ytd-dashboard?team_id=${teamId}&team_name=${encodeURIComponent(teamName)}`;
            window.open(url, '_blank');
        }

        function displayReferralRecipients() {
            const container = document.getElementById('referral-recipients-list');
            
            if (referralRecipients.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🔄</div>
                        <p>No referral recipients configured for ${currentCompany.toUpperCase()}.</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Click "Manage Recipients" to add some.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = referralRecipients.map(recipient => `
                <div class="advisor-card" style="margin-bottom: 0.3rem;">
                    <div class="advisor-info">
                        <div class="advisor-name" style="font-size: 0.9rem;">${recipient.advisor_name}</div>
                        <div class="advisor-details">
                            <span class="status-badge ${recipient.is_active ? 'status-assigned' : 'status-unregistered'}" style="font-size: 0.7rem;">
                                ${recipient.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    <div class="advisor-actions">
                        <button class="btn-sm ${recipient.is_active ? 'btn-unassign' : 'btn-assign'}" 
                                onclick="toggleReferralRecipient(${recipient.advisor_id}, '${recipient.advisor_name}', ${!recipient.is_active})"
                                style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">
                            ${recipient.is_active ? '❌' : '✅'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function loadAdvisorsList() {
            // Get the current advisors from the existing advisor cards
            const advisorCards = document.querySelectorAll('.advisor-card .advisor-name');
            advisorsList = [];
            
            advisorCards.forEach(nameElement => {
                const advisorName = nameElement.textContent.trim();
                // Find the advisor ID from the view button in the same card
                const viewButton = nameElement.closest('.advisor-card').querySelector('[onclick*="viewAdvisorDashboard"]');
                if (viewButton) {
                    const onclickAttr = viewButton.getAttribute('onclick');
                    const match = onclickAttr.match(/viewAdvisorDashboard\((\d+)\)/);
                    if (match) {
                        const advisorId = parseInt(match[1]);
                        advisorsList.push({
                            id: advisorId,
                            name: advisorName
                        });
                    }
                }
            });
            
            console.log('Loaded advisors:', advisorsList);
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Update save button visibility
            const saveBtn = document.getElementById('save-recipients-btn');
            saveBtn.style.display = tabName === 'recipients' ? 'inline-block' : 'none';
            
            currentTab = tabName;
            
            // Load data for the active tab
            if (tabName === 'mappings') {
                loadReferralMappings();
            } else if (tabName === 'unmapped') {
                loadUnmappedReferrals();
            }
        }

        // Referral mappings management
        async function loadReferralMappings() {
            try {
                const response = await fetch('/api/referral-mappings');
                if (response.ok) {
                    referralMappings = await response.json();
                    displayReferralMappings();
                } else {
                    console.error('Failed to load referral mappings');
                }
            } catch (error) {
                console.error('Error loading referral mappings:', error);
            }
        }

        function displayReferralMappings() {
            const container = document.getElementById('mappings-list');
            
            if (referralMappings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🔗</div>
                        <p>No referral mappings configured yet.</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Add mappings to help the system recognize referral names.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = referralMappings.map(mapping => `
                <div class="mapping-item">
                    <div class="mapping-info">
                        <div class="mapping-name">"${mapping.referral_name}"</div>
                        <div class="mapping-target">→ ${mapping.advisor_name}</div>
                    </div>
                    <button class="btn-sm btn-delete" onclick="removeMapping(${mapping.id}, '${mapping.referral_name}')">
                        🗑️ Remove
                    </button>
                </div>
            `).join('');
        }

        function showAddMappingForm() {
            // Populate advisor dropdown
            const select = document.getElementById('new-mapping-advisor');
            select.innerHTML = '<option value="">Select advisor...</option>' + 
                advisorsList.map(advisor => `<option value="${advisor.id}">${advisor.name}</option>`).join('');
            
            document.getElementById('add-mapping-form').style.display = 'block';
            document.getElementById('new-referral-name').focus();
        }

        function hideAddMappingForm() {
            document.getElementById('add-mapping-form').style.display = 'none';
            document.getElementById('new-referral-name').value = '';
            document.getElementById('new-mapping-advisor').value = '';
        }

        async function addMapping() {
            const referralName = document.getElementById('new-referral-name').value.trim();
            const advisorId = document.getElementById('new-mapping-advisor').value;
            
            if (!referralName || !advisorId) {
                alert('Please fill in both fields');
                return;
            }
            
            try {
                const response = await fetch('/api/referral-mappings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        referral_name: referralName,
                        advisor_id: parseInt(advisorId)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    hideAddMappingForm();
                    loadReferralMappings();
                    // Also refresh unmapped list if it's loaded
                    if (unmappedReferrals.length > 0) {
                        loadUnmappedReferrals();
                    }
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error adding mapping: ' + error.message);
            }
        }

        async function removeMapping(mappingId, referralName) {
            if (!confirm(`Are you sure you want to remove the mapping for "${referralName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/referral-mappings/${mappingId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    loadReferralMappings();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error removing mapping: ' + error.message);
            }
        }

        // Unmapped referrals management
        async function loadUnmappedReferrals() {
            try {
                const response = await fetch('/api/unmapped-referrals');
                if (response.ok) {
                    unmappedReferrals = await response.json();
                    displayUnmappedReferrals();
                } else {
                    console.error('Failed to load unmapped referrals');
                }
            } catch (error) {
                console.error('Error loading unmapped referrals:', error);
            }
        }

        function displayUnmappedReferrals() {
            const container = document.getElementById('unmapped-list');
            
            if (unmappedReferrals.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                        <p>All referral names have been mapped!</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">No unmapped referrals found in your submissions.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = unmappedReferrals.map(referralName => `
                <div class="unmapped-item" onclick="quickMap('${referralName}')">
                    <div class="unmapped-name">"${referralName}"</div>
                    <button class="quick-map-btn" onclick="event.stopPropagation(); quickMap('${referralName}')">
                        Quick Map
                    </button>
                </div>
            `).join('');
        }

        function quickMap(referralName) {
            // Pre-fill the add mapping form and switch to mappings tab
            document.getElementById('new-referral-name').value = referralName;
            switchTab('mappings');
            showAddMappingForm();
        }

        function openReferralModal() {
            populateReferralModal();
            document.getElementById('referralModal').style.display = 'block';
        }

        function populateReferralModal() {
            const container = document.getElementById('referral-advisor-list');
            
            if (advisorsList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #7f8c8d;">
                        No registered advisors found.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = advisorsList.map(advisor => {
                const isRecipient = referralRecipients.some(r => r.advisor_id === advisor.id && r.is_active);
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                        <div>
                            <span style="font-weight: 500; color: #2c3e50;">${advisor.name}</span>
                            <div style="font-size: 0.8rem; color: #7f8c8d;">
                                Can receive referrals: <span style="color: ${isRecipient ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                    ${isRecipient ? 'Yes' : 'No'}
                                </span>
                            </div>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" 
                                       id="recipient_${advisor.id}" 
                                       ${isRecipient ? 'checked' : ''}
                                       style="transform: scale(1.2);">
                                <span style="font-size: 0.9rem; color: #2c3e50;">Enable</span>
                            </label>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Edit user credentials function
        function editUserCredentials(advisorId, advisorName) {
            // First, get the current user details
            fetch(`/api/get-user-details/${advisorId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error loading user details: ' + data.error);
                        return;
                    }
                    
                    document.getElementById('editUserId').value = data.id;
                    document.getElementById('editUserFullName').value = data.full_name;
                    document.getElementById('editUserUsername').value = data.username;
                    document.getElementById('editUserEmail').value = data.email;
                    document.getElementById('editUserPassword').value = ''; // Always start empty
                    
                    document.getElementById('editUserModal').style.display = 'block';
                })
                .catch(error => {
                    alert('Error loading user details: ' + error.message);
                });
        }

        // Reset password function
        function resetUserPassword(advisorId, advisorName) {
            document.getElementById('resetUserId').value = advisorId;
            document.getElementById('resetUserName').value = advisorName;
            document.getElementById('resetNewPassword').value = 'password123'; // Default
            document.getElementById('resetPasswordModal').style.display = 'block';
        }

        // Form submission handlers
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Add user_id to data
            data.user_id = parseInt(document.getElementById('editUserId').value);
            
            // Remove password from data if it's empty
            if (!data.password.trim()) {
                delete data.password;
            }
            
            try {
                const response = await fetch('/api/update-user-credentials', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    closeModal('editUserModal');
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error updating credentials: ' + error.message);
            }
        });

        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Add user_id to data
            data.user_id = parseInt(document.getElementById('resetUserId').value);
            
            const confirmReset = confirm(`Are you sure you want to reset the password for ${document.getElementById('resetUserName').value}?`);
            if (!confirmReset) return;
            
            try {
                const response = await fetch('/api/reset-user-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`${result.message}\n\nNew password: ${result.new_password}\n\nPlease share this with the user securely.`);
                    closeModal('resetPasswordModal');
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error resetting password: ' + error.message);
            }
        });

        async function saveReferralSettings() {
            const checkboxes = document.querySelectorAll('#referral-advisor-list input[type="checkbox"]');
            const updates = [];
            
            for (const checkbox of checkboxes) {
                const advisorId = parseInt(checkbox.id.replace('recipient_', ''));
                const isChecked = checkbox.checked;
                const currentRecipient = referralRecipients.find(r => r.advisor_id === advisorId);
                
                // Only update if status has changed
                if (!currentRecipient && isChecked) {
                    updates.push({ advisor_id: advisorId, is_active: true });
                } else if (currentRecipient && currentRecipient.is_active !== isChecked) {
                    updates.push({ advisor_id: advisorId, is_active: isChecked });
                }
            }
            
            if (updates.length === 0) {
                alert('No changes to save.');
                return;
            }
            
            try {
                // Process updates one by one
                for (const update of updates) {
                    const response = await fetch('/api/referral-recipients', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(update)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to update');
                    }
                }
                
                alert(`Successfully updated ${updates.length} referral recipient(s)!`);
                closeModal('referralModal');
                loadReferralRecipients(); // Refresh the display
                
            } catch (error) {
                alert('Error saving referral settings: ' + error.message);
            }
        }

        async function toggleReferralRecipient(advisorId, advisorName, newStatus) {
            const action = newStatus ? 'enable' : 'disable';
            
            if (!confirm(`Are you sure you want to ${action} referral receiving for ${advisorName}?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/referral-recipients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        advisor_id: advisorId,
                        is_active: newStatus
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadReferralRecipients(); // Refresh the display
                } else {
                    const errorData = await response.json();
                    alert('Error: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function unassignFromSpecificTeam(advisorId, advisorName, teamId, teamName) {
            if (confirm(`Are you sure you want to remove ${advisorName} from ${teamName}?`)) {
                try {
                    const response = await fetch('/api/unassign-from-team', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            advisor_id: advisorId,
                            team_id: teamId
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message);
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error: ' + (errorData.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }
        
        // NEW: Manage team memberships function
        function manageTeamMemberships(advisorId, advisorName) {
            document.getElementById('managingAdvisorName').textContent = advisorName;
            
            // Load current teams
            loadAdvisorTeams(advisorId);
            
            // Populate available teams dropdown
            populateAvailableTeams(advisorId);
            
            document.getElementById('teamManagementModal').style.display = 'block';
            window.currentManagingAdvisorId = advisorId;
        }

        
        async function loadAdvisorTeams(advisorId) {
            try {
                // Get advisor's current teams (you'll need to create this endpoint)
                const response = await fetch(`/api/advisor-teams/${advisorId}`);
                const teams = await response.json();
                
                const container = document.getElementById('currentTeamsList');
                
                if (teams.length === 0) {
                    container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 1rem;">No team memberships</p>';
                    return;
                }
                
                container.innerHTML = teams.map(team => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                        <div>
                            <strong>${team.name}</strong>
                            ${team.is_hidden ? '<span class="status-badge status-hidden" style="margin-left: 0.5rem;">Hidden</span>' : ''}
                            <div style="font-size: 0.8rem; color: #7f8c8d;">Goal: £${team.yearly_goal.toLocaleString()}</div>
                        </div>
                        <button class="btn-sm btn-delete" onclick="removeFromTeam(${team.id}, '${team.name}')">
                            Remove
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading advisor teams:', error);
            }
        }
        
        async function populateAvailableTeams(advisorId) {
            try {
                // Get all teams and filter out ones advisor is already in
                const response = await fetch(`/api/available-teams/${advisorId}`);
                const teams = await response.json();
                
                const select = document.getElementById('addTeamSelect');
                select.innerHTML = '<option value="">Choose team to add...</option>' + 
                    teams.map(team => `<option value="${team.id}">${team.name}${team.is_hidden ? ' (Hidden)' : ''}</option>`).join('');
            } catch (error) {
                console.error('Error loading available teams:', error);
            }
        }
        
        async function removeFromTeam(teamId, teamName) {
            const advisorId = window.currentManagingAdvisorId;
            const advisorName = document.getElementById('managingAdvisorName').textContent;
            
            await unassignFromSpecificTeam(advisorId, advisorName, teamId, teamName);
            loadAdvisorTeams(advisorId); // Refresh the list
            populateAvailableTeams(advisorId); // Refresh available teams
        }
        
        async function addToTeam() {
            const teamId = document.getElementById('addTeamSelect').value;
            const advisorId = window.currentManagingAdvisorId;
            
            if (!teamId) {
                alert('Please select a team');
                return;
            }
            
            const yearlyGoal = prompt('Enter yearly goal for this team assignment (£):');
            if (!yearlyGoal) return;
            
            try {
                const response = await fetch('/api/assign-to-team', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        advisor_id: advisorId,
                        team_id: parseInt(teamId),
                        yearly_goal: parseFloat(yearlyGoal)
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadAdvisorTeams(advisorId); // Refresh the list
                    populateAvailableTeams(advisorId); // Refresh available teams
                    document.getElementById('addTeamSelect').value = ''; // Reset selection
                } else {
                    const errorData = await response.json();
                    alert('Error: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        let notificationCount = 0;

        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.id = `notification-${++notificationCount}`;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="hideNotification('${notification.id}')" 
                            style="background: none; border: none; color: inherit; font-size: 1.2rem; cursor: pointer; margin-left: 1rem;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-hide after duration
            setTimeout(() => {
                hideNotification(notification.id);
            }, duration);
            
            return notification.id;
        }

        function hideNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }

        // Main notification functions used by your advisor hiding feature
        function showSuccess(message, duration = 5000) {
            return showNotification(message, 'success', duration);
        }

        function showError(message, duration = 7000) {
            return showNotification(message, 'error', duration);
        }

        function showInfo(message, duration = 5000) {
            return showNotification(message, 'info', duration);
        }

        function showWarning(message, duration = 6000) {
            return showNotification(message, 'warning', duration);
        }

        // Toggle advisor visibility function
        function toggleAdvisorVisibility(advisorId, advisorName) {
            if (confirm(`Are you sure you want to toggle visibility for ${advisorName}?`)) {
                fetch(`/api/toggle-advisor-visibility/${advisorId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess(data.message);
                        
                        // Update the button appearance
                        const button = document.getElementById(`hide-btn-${advisorId}`);
                        if (data.is_hidden) {
                            button.innerHTML = '👁️ Show';
                            button.style.background = '#28a745';
                            button.style.color = 'white';
                            
                            // Add hidden status badge if it doesn't exist
                            const memberItem = button.closest('.member-item');
                            const existingBadge = memberItem.querySelector('.status-badge.status-individual-hidden');
                            if (!existingBadge) {
                                const advisorLink = memberItem.querySelector('a');
                                const hiddenBadge = document.createElement('span');
                                hiddenBadge.className = 'status-badge status-individual-hidden';
                                hiddenBadge.textContent = 'Hidden from Team';
                                advisorLink.parentNode.appendChild(hiddenBadge);
                            }
                        } else {
                            button.innerHTML = '🙈 Hide';
                            button.style.background = '#ffc107';
                            button.style.color = '#212529';
                            
                            // Remove hidden status badge
                            const memberItem = button.closest('.member-item');
                            const hiddenBadge = memberItem.querySelector('.status-badge.status-individual-hidden');
                            if (hiddenBadge) {
                                hiddenBadge.remove();
                            }
                        }
                    } else {
                        showError(data.error || 'Failed to toggle advisor visibility');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Failed to toggle advisor visibility');
                });
            }
        }
    
        function setupEmailReportsEventListeners() {
            const teamSelect = document.getElementById('report-team-select');
            const sendReportBtn = document.getElementById('send-immediate-report');
            const configureBtn = document.getElementById('configure-team-email');
            
            if (teamSelect) {
                teamSelect.addEventListener('change', handleTeamSelection);
            }
            
            if (sendReportBtn) {
                sendReportBtn.addEventListener('click', sendImmediateReport);
            }
            
            if (configureBtn) {
                configureBtn.addEventListener('click', openEmailConfiguration);
            }
        }
        
        async function loadEmailReportsData() {
            try {
                // Load teams and email configurations using same pattern as YTD dashboard
                const response = await fetch('/api/email-config/teams');
                const data = await response.json();
                
                if (response.ok) {
                    teams = data.teams;
                    updateTeamsDropdown();
                    updateEmailSummary(data);
                }
            } catch (error) {
                console.error('Error loading email reports data:', error);
            }
        }
        
        function updateTeamsDropdown() {
            const select = document.getElementById('report-team-select');
            if (!select) return;
            
            // Clear existing options except first
            select.innerHTML = '<option value="">Select a team...</option>';
            
            // Add team options with activity indicators like YTD dashboard
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.team_id;
                option.textContent = `${team.team_name} (${team.member_count} members)`;
                option.dataset.emailEnabled = team.email_enabled;
                option.dataset.hasData = team.has_submissions;
                
                // Add visual indicator for teams with no data
                if (!team.has_submissions) {
                    option.textContent += ' - No Recent Activity';
                    option.style.color = '#999';
                }
                
                select.appendChild(option);
            });
        }
        
        function handleTeamSelection() {
            const select = document.getElementById('report-team-select');
            const sendBtn = document.getElementById('send-immediate-report');
            const configBtn = document.getElementById('configure-team-email');
            const statusDiv = document.getElementById('team-email-status');
            
            const teamId = select.value;
            const selectedOption = select.options[select.selectedIndex];
            
            if (teamId) {
                sendBtn.disabled = false;
                configBtn.disabled = false;
                
                const team = teams.find(t => t.team_id == teamId);
                if (team) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-${team.email_enabled ? 'check-circle' : 'times-circle'}" 
                            style="color: ${team.email_enabled ? '#28a745' : '#dc3545'};"></i>
                            <strong>${team.team_name}</strong>
                            <span style="color: ${team.email_enabled ? '#28a745' : '#dc3545'};">
                                ${team.email_enabled ? 'Email Enabled' : 'Email Disabled'}
                            </span>
                        </div>
                        ${team.email_enabled ? `
                            <div style="font-size: 0.9rem; color: #666;">
                                <div>📧 Recipients: ${Array.isArray(team.recipient_emails) ? team.recipient_emails.join(', ') : team.recipient_emails}</div>
                                <div>📅 Schedule: ${team.send_day} at ${team.send_time}</div>
                            </div>
                        ` : `
                            <div style="color: #dc3545; font-size: 0.9rem;">
                                Configure email settings to enable automated reports
                            </div>
                        `}
                    `;
                    
                    // Update button text based on email status
                    if (team.email_enabled) {
                        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Monthly Report Now';
                        sendBtn.className = 'btn btn-primary';
                    } else {
                        sendBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Configure Monthly Reports First';
                        sendBtn.className = 'btn btn-warning';
                    }
                }
            } else {
                sendBtn.disabled = true;
                configBtn.disabled = true;
                statusDiv.style.display = 'none';
            }
        }
        
        async function sendImmediateReport() {
            const select = document.getElementById('report-team-select');
            const sendBtn = document.getElementById('send-immediate-report');
            
            const teamId = select.value;
            const team = teams.find(t => t.team_id == teamId);
            
            if (!team) {
                showToast('Please select a team first', 'error');
                return;
            }
            
            if (!team.email_enabled) {
                showToast('Monthly email reports are not configured for this team. Please configure email settings first.', 'warning');
                openEmailConfiguration();
                return;
            }
            
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            sendBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/email-config/test/${teamId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast(`Monthly report sent successfully to ${team.team_name} recipients!`, 'success');
                } else {
                    showToast(result.message || 'Failed to send monthly report', 'error');
                }
            } catch (error) {
                console.error('Error sending immediate report:', error);
                showToast('Failed to send monthly report', 'error');
            } finally {
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
            }
        }
        
        function openEmailConfiguration() {
            const select = document.getElementById('report-team-select');
            const teamId = select.value;
            
            if (teamId) {
                window.location.href = `/master/email-config#team-${teamId}`;
            } else {
                window.location.href = '/master/email-config';
            }
        }
        
        function updateEmailSummary(data) {
            const enabledCount = data.teams.filter(t => t.email_enabled).length;
            const schedulerStatus = data.scheduler_status;
            
            // Update enabled teams count
            const enabledCountElement = document.getElementById('enabled-teams-count');
            if (enabledCountElement) {
                enabledCountElement.textContent = enabledCount;
            }
            
            // Update scheduler status
            const statusIndicator = document.getElementById('scheduler-status-indicator');
            if (statusIndicator) {
                statusIndicator.textContent = schedulerStatus.is_running ? '🟢' : '🔴';
                statusIndicator.className = schedulerStatus.is_running ? 'metric-value scheduler-running' : 'metric-value scheduler-stopped';
            }
            
            // Update next reports (simplified version - you can enhance this)
            const nextReportsList = document.getElementById('next-reports-list');
            if (nextReportsList) {
                const enabledTeams = data.teams.filter(t => t.email_enabled);
                
                if (enabledTeams.length === 0) {
                    nextReportsList.innerHTML = '<p style="color: #666; font-style: italic;">No teams configured for monthly email reports</p>';
                } else {
                    nextReportsList.innerHTML = enabledTeams.map(team => `
                        <div class="next-report-item">
                            <span class="team-name">${team.team_name}</span>
                            <span class="report-time">Monthly on ${team.send_day} at ${team.send_time}</span>
                        </div>
                    `).join('');
                }
            }
        }
        
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                z-index: 1000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#dc3545'};
            `;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            
            // Hide toast after 4 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Auto-refresh email data every 60 seconds
        setInterval(loadEmailReportsData, 60000);
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Update company indicator
            const companySelect = document.getElementById('company-selector');
            const companyIndicator = document.getElementById('company-indicator');
            // Load referral data
            loadReferralRecipients();
            loadAdvisorsList();
            loadEmailReportsData();
            setupEmailReportsEventListeners();
            
            if (companySelect.value) {
                companyIndicator.textContent = companySelect.value.toUpperCase();
            }
        });


    </script>

    <style>
        /* Additional styles for referral management */
        #referral-advisor-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.5rem;
        }

        #referral-advisor-list::-webkit-scrollbar {
            width: 6px;
        }

        #referral-advisor-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #referral-advisor-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        #referral-advisor-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .modal-content {
            max-width: 600px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Referral Recipients Bottom Section */
        .referral-recipients-bottom {
            margin-top: 2rem;
        }

        .referral-compact {
            max-height: 300px;
            overflow-y: auto;
        }

        .referral-compact .section-header {
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        .referral-compact .section-title {
            font-size: 1.1rem;
        }

        .referral-compact .advisor-card {
            margin-bottom: 0.5rem;
            padding: 0.75rem;
        }

        .referral-compact .advisor-name {
            font-size: 0.9rem;
        }

        .referral-compact .advisor-details {
            font-size: 0.8rem;
        }

        .referral-compact .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>